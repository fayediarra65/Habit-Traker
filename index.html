<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker AvancÃ© Complet</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E8D5C4 0%, #F5E6D8 50%, #E8C4D5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #FFF8F3;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(139, 90, 69, 0.2);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            border-radius: 15px;
            color: white;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #E8D5C4;
            flex-wrap: wrap;
        }
        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #8B5A45;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active { 
            color: #6B4532; 
            border-bottom-color: #C9A58C;
            background: #F5E6D8;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }
        .stat-card .number { font-size: 2.5em; font-weight: bold; }
        .stat-card .label { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .add-section {
            background: #FFF8F3;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #E8D5C4;
        }
        .add-section h3 { color: #8B5A45; margin-bottom: 15px; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: bold; color: #6B4532; font-size: 0.9em; }
        .form-input, .form-select, .form-textarea {
            padding: 10px;
            border: 2px solid #E8D5C4;
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #C9A58C;
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .btn-primary {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        .btn-primary:hover { transform: scale(1.05); }
        .items-grid { display: grid; gap: 15px; margin-bottom: 30px; }
        .item-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1);
            border-left: 5px solid #C9A58C;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .item-title { font-size: 1.2em; font-weight: bold; color: #6B4532; flex: 1; }
        .item-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge-urgent { background: #D98880; color: white; }
        .badge-important { background: #E8C4A0; color: #6B4532; }
        .badge-normal { background: #90C890; color: white; }
        .badge-later { background: #C4D5E8; color: #455566; }
        .badge-daily { background: #E8C4D5; color: #6B4555; }
        .badge-weekly { background: #C4D5E8; color: #455566; }
        .badge-temporary { background: #E8C4A0; color: #6B4532; }
        .item-days {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .day-box {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #C9A58C;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.2s;
            background: white;
        }
        .day-box.checked {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
        }
        .day-box:hover { transform: scale(1.1); }
        .item-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn-small:hover { transform: scale(1.05); }
        .btn-done { background: #90C890; color: white; }
        .btn-edit { background: #C9A58C; color: white; }
        .btn-delete { background: #D98880; color: white; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(139, 90, 69, 0.4);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn {
            padding: 8px 20px;
            border: 2px solid #C9A58C;
            background: white;
            color: #8B5A45;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .filter-btn:hover { transform: scale(1.05); }
        .filter-btn.active { 
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%); 
            color: white; 
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #A0826D;
            font-style: italic;
        }
        .rewards-section {
            background: linear-gradient(135deg, #E8C4A0 0%, #D9B38C 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }
        .rewards-points { font-size: 4em; font-weight: bold; margin: 20px 0; }
        .calendar-view {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            color: #C9A58C;
            padding: 10px;
        }
        .calendar-day {
            min-height: 100px;
            border: 2px solid #E8D5C4;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: white;
        }
        .calendar-day:hover { border-color: #C9A58C; background: #FFF8F3; }
        .calendar-day.has-items { background: linear-gradient(135deg, #E8D5C420 0%, #C9A58C20 100%); }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #6B4532;
        }
        .day-items {
            font-size: 0.75em;
            color: #8B5A45;
        }
        .day-items div {
            margin: 2px 0;
            padding: 2px 5px;
            background: #C9A58C;
            color: white;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1);
        }
        .chart-box h3 {
            color: #8B5A45;
            margin-bottom: 15px;
            text-align: center;
        }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .charts-row { grid-template-columns: 1fr; }
            .calendar-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Mon Tracker AvancÃ©</h1>
            <p>Habitudes â€¢ TÃ¢ches â€¢ Objectifs â€¢ Suivi complet</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š Dashboard</button>
            <button class="tab" onclick="switchTab('habits')">âœ¨ Habitudes</button>
            <button class="tab" onclick="switchTab('tasks')">ğŸ“‹ TÃ¢ches</button>
            <button class="tab" onclick="switchTab('calendar')">ğŸ“… Calendrier</button>
            <button class="tab" onclick="switchTab('goals')">ğŸ¯ Objectifs</button>
            <button class="tab" onclick="switchTab('rewards')">ğŸ† RÃ©compenses</button>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="totalPoints">0</div>
                    <div class="label">ğŸ† Points</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="habitsCompleted">0/0</div>
                    <div class="label">âœ¨ Habitudes aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="tasksCompleted">0/0</div>
                    <div class="label">ğŸ“‹ TÃ¢ches terminÃ©es</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="streak">0</div>
                    <div class="label">ğŸ”¥ SÃ©rie (jours)</div>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn-primary" onclick="exportPDF()">ğŸ“¤ Exporter rapport PDF</button>
                <button class="btn-primary" onclick="requestNotificationPermission()">ğŸ”” Activer notifications</button>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <h3>ğŸ“ˆ Ã‰volution (7 derniers jours)</h3>
                    <canvas id="evolutionChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3>ğŸ¯ RÃ©partition des tÃ¢ches</h3>
                    <canvas id="tasksChart"></canvas>
                </div>
            </div>
        </div>

        <!-- HABITUDES -->
        <div id="habits" class="tab-content">
            <div class="add-section">
                <h3 id="habitFormTitle">â• Ajouter une habitude</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom de l'habitude *</label>
                        <input type="text" id="habitName" class="form-input" placeholder="Ex: Faire du sport">
                    </div>
                    <div class="form-group">
                        <label>FrÃ©quence *</label>
                        <select id="habitType" class="form-select">
                            <option value="daily">Quotidienne</option>
                            <option value="weekly">2-3x par semaine</option>
                            <option value="temporary">Temporaire (pÃ©riode)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>â° Rappel</label>
                        <input type="time" id="habitReminder" class="form-input">
                    </div>
                </div>
                <div class="form-row" id="tempDates" style="display: none;">
                    <div class="form-group">
                        <label>Date de fin</label>
                        <input type="date" id="habitEndDate" class="form-input">
                    </div>
                </div>
                <button class="btn-primary" id="habitSubmitBtn" onclick="addHabit()">âœ¨ Ajouter</button>
                <button class="btn-primary" id="habitCancelBtn" onclick="cancelEditHabit()" style="display: none; background: #999;">âŒ Annuler</button>
            </div>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterItems('habits', 'all')">Toutes</button>
                <button class="filter-btn" onclick="filterItems('habits', 'daily')">Quotidiennes</button>
                <button class="filter-btn" onclick="filterItems('habits', 'weekly')">Hebdo</button>
                <button class="filter-btn" onclick="filterItems('habits', 'temporary')">Temporaires</button>
            </div>

            <div class="items-grid" id="habitsList"></div>
        </div>

        <!-- TÃ‚CHES -->
        <div id="tasks" class="tab-content">
            <div class="add-section">
                <h3 id="taskFormTitle">â• Ajouter une tÃ¢che</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Titre *</label>
                        <input type="text" id="taskTitle" class="form-input" placeholder="Ex: Finir le rapport">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="taskType" class="form-select">
                            <option value="work">ğŸ’¼ Professionnel</option>
                            <option value="personal">ğŸ  Personnel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PrioritÃ© *</label>
                        <select id="taskPriority" class="form-select">
                            <option value="urgent">ğŸ”´ Urgent (aujourd'hui)</option>
                            <option value="important">ğŸŸ¡ Important (semaine)</option>
                            <option value="normal">ğŸŸ¢ Normal</option>
                            <option value="later">ğŸ”µ Plus tard (2-3 sem)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>â° Date limite</label>
                        <input type="date" id="taskDeadline" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>â° Rappel</label>
                        <input type="datetime-local" id="taskReminder" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="taskNotes" class="form-textarea" placeholder="DÃ©tails..."></textarea>
                </div>
                <button class="btn-primary" id="taskSubmitBtn" onclick="addTask()">ğŸ“‹ Ajouter</button>
                <button class="btn-primary" id="taskCancelBtn" onclick="cancelEditTask()" style="display: none; background: #999;">âŒ Annuler</button>
            </div>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterItems('tasks', 'all')">Toutes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'urgent')">ğŸ”´ Urgentes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'important')">ğŸŸ¡ Importantes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'later')">ğŸ”µ Plus tard</button>
            </div>

            <div class="items-grid" id="tasksList"></div>
        </div>

        <!-- CALENDRIER -->
        <div id="calendar" class="tab-content">
            <div class="calendar-view">
                <div class="calendar-header">
                    <button class="btn-primary" onclick="changeMonth(-1)">â—€ PrÃ©cÃ©dent</button>
                    <h2 style="color: #f8a5c2;" id="calendarMonth">DÃ©cembre 2024</h2>
                    <button class="btn-primary" onclick="changeMonth(1)">Suivant â–¶</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Lun</div>
                    <div class="calendar-day-header">Mar</div>
                    <div class="calendar-day-header">Mer</div>
                    <div class="calendar-day-header">Jeu</div>
                    <div class="calendar-day-header">Ven</div>
                    <div class="calendar-day-header">Sam</div>
                    <div class="calendar-day-header">Dim</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <!-- OBJECTIFS -->
        <div id="goals" class="tab-content">
            <div class="add-section">
                <h3 id="goalFormTitle">ğŸ¯ Ajouter un objectif Ã  long terme</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Objectif *</label>
                        <input type="text" id="goalTitle" class="form-input" placeholder="Ex: Perdre 10kg">
                    </div>
                    <div class="form-group">
                        <label>CatÃ©gorie</label>
                        <select id="goalCategory" class="form-select">
                            <option value="health">ğŸƒ SantÃ©</option>
                            <option value="career">ğŸ’¼ CarriÃ¨re</option>
                            <option value="learning">ğŸ“š Apprentissage</option>
                            <option value="finance">ğŸ’° Finance</option>
                            <option value="personal">ğŸŒŸ Personnel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… Date limite</label>
                        <input type="date" id="goalDeadline" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="goalDescription" class="form-textarea" placeholder="DÃ©crivez votre objectif..."></textarea>
                </div>
                <button class="btn-primary" id="goalSubmitBtn" onclick="addGoal()">ğŸ¯ Ajouter</button>
                <button class="btn-primary" id="goalCancelBtn" onclick="cancelEditGoal()" style="display: none; background: #999;">âŒ Annuler</button>
            </div>

            <div class="items-grid" id="goalsList"></div>
        </div>

        <!-- RÃ‰COMPENSES -->
        <div id="rewards" class="tab-content">
            <div class="rewards-section">
                <h2>ğŸ† SystÃ¨me de RÃ©compenses</h2>
                <div class="rewards-points" id="rewardsPoints">0 pts</div>
                <p style="font-size: 1.2em;">Niveau <span id="level">1</span> - <span id="levelName">DÃ©butant</span></p>
                <p style="margin-top: 20px;">âœ¨ +10 pts par habitude complÃ©tÃ©e</p>
                <p>ğŸ“‹ +20 pts par tÃ¢che terminÃ©e</p>
                <p>ğŸ”¥ +50 pts bonus sÃ©rie de 7 jours</p>
                <p>ğŸ¯ +100 pts par objectif atteint</p>
            </div>
        </div>
    </div>

    <script>
        let data = { 
            habits: [], 
            tasks: [], 
            goals: [], 
            points: 0, 
            streak: 0, 
            filter: 'all', 
            editingId: null, 
            editingType: null, 
            history: [] 
        };
        let currentMonth = new Date();
        let charts = {};

        function loadData() {
            const saved = localStorage.getItem('tracker_advanced_v2');
            if (saved) {
                data = JSON.parse(saved);
                render();
                updateCharts();
            }
        }

        function saveData() {
            localStorage.setItem('tracker_advanced_v2', JSON.stringify(data));
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            if (tab === 'calendar') renderCalendar();
        }

        document.getElementById('habitType').addEventListener('change', (e) => {
            document.getElementById('tempDates').style.display = e.target.value === 'temporary' ? 'grid' : 'none';
        });

        // === HABITUDES ===
        function addHabit() {
            const name = document.getElementById('habitName').value.trim();
            if (!name) return showNotif('âš ï¸ Entrez un nom');

            if (data.editingId && data.editingType === 'habit') {
                const habit = data.habits.find(h => h.id === data.editingId);
                habit.name = name;
                habit.type = document.getElementById('habitType').value;
                habit.endDate = document.getElementById('habitEndDate').value || null;
                habit.reminder = document.getElementById('habitReminder').value || null;
                showNotif('âœï¸ Habitude modifiÃ©e !');
                cancelEditHabit();
            } else {
                data.habits.push({
                    id: Date.now(),
                    name,
                    type: document.getElementById('habitType').value,
                    endDate: document.getElementById('habitEndDate').value || null,
                    reminder: document.getElementById('habitReminder').value || null,
                    days: [],
                    completed: 0,
                    createdAt: new Date().toISOString()
                });
                showNotif('âœ¨ Habitude ajoutÃ©e !');
            }

            document.getElementById('habitName').value = '';
            document.getElementById('habitEndDate').value = '';
            document.getElementById('habitReminder').value = '';
            saveData();
            render();
        }

        function editHabit(id) {
            const habit = data.habits.find(h => h.id === id);
            data.editingId = id;
            data.editingType = 'habit';
            
            document.getElementById('habitName').value = habit.name;
            document.getElementById('habitType').value = habit.type;
            document.getElementById('habitEndDate').value = habit.endDate || '';
            document.getElementById('habitReminder').value = habit.reminder || '';
            document.getElementById('tempDates').style.display = habit.type === 'temporary' ? 'grid' : 'none';
            
            document.getElementById('habitFormTitle').textContent = 'âœï¸ Modifier l\'habitude';
            document.getElementById('habitSubmitBtn').textContent = 'ğŸ’¾ Enregistrer';
            document.getElementById('habitCancelBtn').style.display = 'inline-block';
            
            document.getElementById('habitName').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditHabit() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('habitName').value = '';
            document.getElementById('habitEndDate').value = '';
            document.getElementById('habitReminder').value = '';
            document.getElementById('habitFormTitle').textContent = 'â• Ajouter une habitude';
            document.getElementById('habitSubmitBtn').textContent = 'âœ¨ Ajouter';
            document.getElementById('habitCancelBtn').style.display = 'none';
        }

        // === TÃ‚CHES ===
        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) return showNotif('âš ï¸ Entrez un titre');

            if (data.editingId && data.editingType === 'task') {
                const task = data.tasks.find(t => t.id === data.editingId);
                task.title = title;
                task.type = document.getElementById('taskType').value;
                task.priority = document.getElementById('taskPriority').value;
                task.deadline = document.getElementById('taskDeadline').value || null;
                task.reminder = document.getElementById('taskReminder').value || null;
                task.notes = document.getElementById('taskNotes').value || '';
                showNotif('âœï¸ TÃ¢che modifiÃ©e !');
                cancelEditTask();
            } else {
                data.tasks.push({
                    id: Date.now(),
                    title,
                    type: document.getElementById('taskType').value,
                    priority: document.getElementById('taskPriority').value,
                    deadline: document.getElementById('taskDeadline').value || null,
                    reminder: document.getElementById('taskReminder').value || null,
                    notes: document.getElementById('taskNotes').value || '',
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                showNotif('ğŸ“‹ TÃ¢che ajoutÃ©e !');
            }

            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDeadline').value = '';
            document.getElementById('taskReminder').value = '';
            document.getElementById('taskNotes').value = '';
            saveData();
            render();
        }

        function editTask(id) {
            const task = data.tasks.find(t => t.id === id);
            data.editingId = id;
            data.editingType = 'task';
            
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskType').value = task.type;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskDeadline').value = task.deadline || '';
            document.getElementById('taskReminder').value = task.reminder || '';
            document.getElementById('taskNotes').value = task.notes || '';
            
            document.getElementById('taskFormTitle').textContent = 'âœï¸ Modifier la tÃ¢che';
            document.getElementById('taskSubmitBtn').textContent = 'ğŸ’¾ Enregistrer';
            document.getElementById('taskCancelBtn').style.display = 'inline-block';
            
            document.getElementById('taskTitle').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditTask() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDeadline').value = '';
            document.getElementById('taskReminder').value = '';
            document.getElementById('taskNotes').value = '';
            document.getElementById('taskFormTitle').textContent = 'â• Ajouter une tÃ¢che';
            document.getElementById('taskSubmitBtn').textContent = 'ğŸ“‹ Ajouter';
            document.getElementById('taskCancelBtn').style.display = 'none';
        }

        // === OBJECTIFS ===
        function addGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            if (!title) return showNotif('âš ï¸ Entrez un objectif');

            if (data.editingId && data.editingType === 'goal') {
                const goal = data.goals.find(g => g.id === data.editingId);
                goal.title = title;
                goal.category = document.getElementById('goalCategory').value;
                goal.deadline = document.getElementById('goalDeadline').value || null;
                goal.description = document.getElementById('goalDescription').value || '';
                showNotif('âœï¸ Objectif modifiÃ© !');
                cancelEditGoal();
            } else {
                data.goals.push({
                    id: Date.now(),
                    title,
                    category: document.getElementById('goalCategory').value,
                    deadline: document.getElementById('goalDeadline').value || null,
                    description: document.getElementById('goalDescription').value || '',
                    completed: false,
                    progress: 0,
                    createdAt: new Date().toISOString()
                });
                showNotif('ğŸ¯ Objectif ajoutÃ© !');
            }

            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDeadline').value = '';
            document.getElementById('goalDescription').value = '';
            saveData();
            render();
        }

        function editGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            data.editingId = id;
            data.editingType = 'goal';
            
            document.getElementById('goalTitle').value = goal.title;
            document.getElementById('goalCategory').value = goal.category;
            document.getElementById('goalDeadline').value = goal.deadline || '';
            document.getElementById('goalDescription').value = goal.description || '';
            
            document.getElementById('goalFormTitle').textContent = 'âœï¸ Modifier l\'objectif';
            document.getElementById('goalSubmitBtn').textContent = 'ğŸ’¾ Enregistrer';
            document.getElementById('goalCancelBtn').style.display = 'inline-block';
            
            document.getElementById('goalTitle').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditGoal() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDeadline').value = '';
            document.getElementById('goalDescription').value = '';
            document.getElementById('goalFormTitle').textContent = 'ğŸ¯ Ajouter un objectif';
            document.getElementById('goalSubmitBtn').textContent = 'ğŸ¯ Ajouter';
            document.getElementById('goalCancelBtn').style.display = 'none';
        }

        function toggleGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            goal.completed = !goal.completed;
            if (goal.completed) {
                data.points += 100;
                showNotif('ğŸ‰ Objectif atteint ! +100 points');
            } else {
                data.points -= 100;
            }
            saveData();
            render();
        }

        function toggleDay(habitId, day) {
            const habit = data.habits.find(h => h.id === habitId);
            const idx = habit.days.indexOf(day);
            
            if (idx > -1) {
                habit.days.splice(idx, 1);
                habit.completed--;
                data.points -= 10;
                showNotif('â†©ï¸ -10 points');
            } else {
                habit.days.push(day);
                habit.completed++;
                data.points += 10;
                showNotif('âœ¨ +10 points !');
                checkAchievements();
            }
            
            trackHistory('habit', habitId, idx > -1 ? 'unchecked' : 'checked');
            saveData();
            render();
            updateCharts();
        }

        function toggleTask(id) {
            const task = data.tasks.find(t => t.id === id);
            task.completed = !task.completed;
            
            if (task.completed) {
                data.points += 20;
                showNotif('ğŸ‰ +20 points !');
            } else {
                data.points -= 20;
                showNotif('â†©ï¸ -20 points');
            }
            
            trackHistory('task', id, task.completed ? 'completed' : 'uncompleted');
            saveData();
            render();
            updateCharts();
        }

        function deleteItem(type, id) {
            // DÃ©terminer le bon tableau selon le type
            if (type === 'habit') {
                data.habits = data.habits.filter(item => item.id !== id);
            } else if (type === 'task') {
                data.tasks = data.tasks.filter(item => item.id !== id);
            } else if (type === 'goal') {
                data.goals = data.goals.filter(item => item.id !== id);
            }
            
            showNotif('ğŸ—‘ï¸ SupprimÃ© avec succÃ¨s !');
            saveData();
            render();
            updateCharts();
        }

        function filterItems(type, filter) {
            data.filter = filter;
            const parent = event.target.parentElement;
            parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }

        function trackHistory(type, id, action) {
            const today = new Date().toISOString().split('T')[0];
            if (!data.history) data.history = [];
            data.history.push({ type, id, action, date: today });
            if (data.history.length > 100) data.history.shift();
        }

        function getWeekDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - d.getDay() + i + 1);
                days.push(d.toISOString().split('T')[0]);
            }
            return days;
        }

        function render() {
            const weekDays = getWeekDays();
            const dayNames = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];

            let filteredHabits = data.habits;
            let filteredTasks = data.tasks;
            let filteredGoals = data.goals;

            if (data.filter !== 'all') {
                filteredHabits = data.habits.filter(h => h.type === data.filter);
                filteredTasks = data.tasks.filter(t => t.priority === data.filter || t.type === data.filter);
            }

            // HABITUDES
            document.getElementById('habitsList').innerHTML = filteredHabits.length ? filteredHabits.map(h => `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-title">${h.name}</div>
                        <span class="item-badge badge-${h.type}">${
                            h.type === 'daily' ? 'Quotidienne' :
                            h.type === 'weekly' ? 'Hebdo' : 'Temporaire'
                        }</span>
                    </div>
                    ${h.reminder ? `<p style="color: #666; font-size: 0.9em;">â° Rappel : ${h.reminder}</p>` : ''}
                    ${h.endDate ? `<p style="color: #666; font-size: 0.9em;">ğŸ“… Jusqu'au : ${new Date(h.endDate).toLocaleDateString('fr')}</p>` : ''}
                    <div class="item-days">
                        ${weekDays.map((day, i) => `
                            <div class="day-box ${h.days.includes(day) ? 'checked' : ''}" 
                                 onclick="toggleDay(${h.id}, '${day}')">
                                ${dayNames[i]}
                            </div>
                        `).join('')}
                    </div>
                    <p style="color: #666; margin-top: 10px;">âœ… ${h.completed || 0} fois complÃ©tÃ©e</p>
                    <div class="item-actions">
                        <button class="btn-small btn-edit" onclick="editHabit(${h.id})">âœï¸ Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('habit', ${h.id})">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">ğŸ“­ Aucune habitude pour le moment</div>';

            // TÃ‚CHES
            document.getElementById('tasksList').innerHTML = filteredTasks.length ? filteredTasks.map(t => `
                <div class="item-card" style="${t.completed ? 'opacity: 0.6;' : ''}">
                    <div class="item-header">
                        <div class="item-title" style="${t.completed ? 'text-decoration: line-through;' : ''}">${t.title}</div>
                        <span class="item-badge badge-${t.priority}">${
                            t.priority === 'urgent' ? 'ğŸ”´ Urgent' :
                            t.priority === 'important' ? 'ğŸŸ¡ Important' :
                            t.priority === 'normal' ? 'ğŸŸ¢ Normal' : 'ğŸ”µ Plus tard'
                        }</span>
                    </div>
                    <p style="color: #666; margin: 10px 0;">${t.type === 'work' ? 'ğŸ’¼ Pro' : 'ğŸ  Perso'}</p>
                    ${t.deadline ? `<p style="color: #666;">ğŸ“… ${new Date(t.deadline).toLocaleDateString('fr')}</p>` : ''}
                    ${t.reminder ? `<p style="color: #666;">â° ${new Date(t.reminder).toLocaleString('fr')}</p>` : ''}
                    ${t.notes ? `<p style="color: #666; font-style: italic; margin-top: 10px;">${t.notes}</p>` : ''}
                    <div class="item-actions">
                        <button class="btn-small btn-done" onclick="toggleTask(${t.id})">
                            ${t.completed ? 'â†©ï¸ RÃ©activer' : 'âœ… Terminer'}
                        </button>
                        <button class="btn-small btn-edit" onclick="editTask(${t.id})">âœï¸ Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('task', ${t.id})">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">ğŸ“­ Aucune tÃ¢che pour le moment</div>';

            // OBJECTIFS
            document.getElementById('goalsList').innerHTML = filteredGoals.length ? filteredGoals.map(g => `
                <div class="item-card" style="${g.completed ? 'opacity: 0.6;' : ''}">
                    <div class="item-header">
                        <div class="item-title" style="${g.completed ? 'text-decoration: line-through;' : ''}">${g.title}</div>
                        <span class="item-badge badge-normal">${
                            g.category === 'health' ? 'ğŸƒ SantÃ©' :
                            g.category === 'career' ? 'ğŸ’¼ CarriÃ¨re' :
                            g.category === 'learning' ? 'ğŸ“š Apprentissage' :
                            g.category === 'finance' ? 'ğŸ’° Finance' : 'ğŸŒŸ Personnel'
                        }</span>
                    </div>
                    ${g.deadline ? `<p style="color: #666; margin: 10px 0;">ğŸ“… ${new Date(g.deadline).toLocaleDateString('fr')}</p>` : ''}
                    ${g.description ? `<p style="color: #666; font-style: italic;">${g.description}</p>` : ''}
                    <div class="item-actions">
                        <button class="btn-small btn-done" onclick="toggleGoal(${g.id})">
                            ${g.completed ? 'â†©ï¸ RÃ©activer' : 'âœ… Atteint'}
                        </button>
                        <button class="btn-small btn-edit" onclick="editGoal(${g.id})">âœï¸ Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('goal', ${g.id})">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">ğŸ“­ Aucun objectif pour le moment</div>';

            updateStats();
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const completedToday = data.habits.filter(h => h.days.includes(today)).length;
            const completedTasks = data.tasks.filter(t => t.completed).length;

            document.getElementById('totalPoints').textContent = data.points || 0;
            document.getElementById('habitsCompleted').textContent = `${completedToday}/${data.habits.length}`;
            document.getElementById('tasksCompleted').textContent = `${completedTasks}/${data.tasks.length}`;
            document.getElementById('streak').textContent = calculateStreak();
            document.getElementById('rewardsPoints').textContent = (data.points || 0) + ' pts';

            const level = Math.floor((data.points || 0) / 100) + 1;
            const levelNames = ['DÃ©butant', 'MotivÃ©', 'RÃ©gulier', 'Expert', 'MaÃ®tre', 'LÃ©gende'];
            document.getElementById('level').textContent = level;
            document.getElementById('levelName').textContent = levelNames[Math.min(level - 1, 5)];
        }

        function calculateStreak() {
            if (!data.history || data.history.length === 0) return 0;
            
            let streak = 0;
            let currentDate = new Date();
            
            for (let i = 0; i < 30; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const hasActivity = data.history.some(h => h.date === dateStr && h.action === 'checked');
                
                if (hasActivity) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function checkAchievements() {
            const streak = calculateStreak();
            if (streak === 7 && data.points >= 50) {
                data.points += 50;
                showNotif('ğŸ”¥ SÃ©rie de 7 jours ! +50 points bonus');
            }
        }

        // CALENDRIER
        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                               'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < adjustedFirstDay; i++) {
                grid.innerHTML += '<div class="calendar-day" style="opacity: 0.3;"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const habitsOnDay = data.habits.filter(h => h.days.includes(dateStr));
                const tasksOnDay = data.tasks.filter(t => t.deadline === dateStr);
                
                const hasItems = habitsOnDay.length > 0 || tasksOnDay.length > 0;
                
                grid.innerHTML += `
                    <div class="calendar-day ${hasItems ? 'has-items' : ''}">
                        <div class="day-number">${day}</div>
                        <div class="day-items">
                            ${habitsOnDay.slice(0, 2).map(h => `<div>âœ¨ ${h.name.substring(0, 15)}...</div>`).join('')}
                            ${tasksOnDay.slice(0, 2).map(t => `<div>ğŸ“‹ ${t.title.substring(0, 15)}...</div>`).join('')}
                            ${(habitsOnDay.length + tasksOnDay.length > 2) ? `<div>+${habitsOnDay.length + tasksOnDay.length - 2} autre(s)</div>` : ''}
                        </div>
                    </div>
                `;
            }
        }

        function changeMonth(direction) {
            currentMonth.setMonth(currentMonth.getMonth() + direction);
            renderCalendar();
        }

        // GRAPHIQUES
        function updateCharts() {
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toISOString().split('T')[0]);
            }

            const habitsData = last7Days.map(day => 
                data.habits.filter(h => h.days.includes(day)).length
            );

            const tasksData = last7Days.map(day => 
                data.tasks.filter(t => t.completed && t.createdAt && t.createdAt.startsWith(day)).length
            );

            if (charts.evolution) charts.evolution.destroy();
            const ctx1 = document.getElementById('evolutionChart').getContext('2d');
            charts.evolution = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => new Date(d).toLocaleDateString('fr', { weekday: 'short' })),
                    datasets: [{
                        label: 'Habitudes',
                        data: habitsData,
                        borderColor: '#f8a5c2',
                        backgroundColor: 'rgba(248, 165, 194, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'TÃ¢ches',
                        data: tasksData,
                        borderColor: '#a6c1ee',
                        backgroundColor: 'rgba(166, 193, 238, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });

            if (charts.tasks) charts.tasks.destroy();
            const ctx2 = document.getElementById('tasksChart').getContext('2d');
            const urgentTasks = data.tasks.filter(t => t.priority === 'urgent').length;
            const importantTasks = data.tasks.filter(t => t.priority === 'important').length;
            const normalTasks = data.tasks.filter(t => t.priority === 'normal').length;
            const laterTasks = data.tasks.filter(t => t.priority === 'later').length;

            charts.tasks = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Urgentes', 'Importantes', 'Normales', 'Plus tard'],
                    datasets: [{
                        data: [urgentTasks, importantTasks, normalTasks, laterTasks],
                        backgroundColor: ['#ff6b6b', '#ffd93d', '#6bcf7f', '#a6c1ee']
                    }]
                },
                options: { responsive: true }
            });
        }

        // NOTIFICATIONS
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotif('ğŸ”” Notifications activÃ©es !');
                    } else {
                        showNotif('âš ï¸ Notifications refusÃ©es');
                    }
                });
            }
        }

        function checkReminders() {
            const now = new Date();
            const nowStr = now.toISOString().substring(0, 16);
            
            data.habits.forEach(h => {
                if (h.reminder) {
                    const [hours, minutes] = h.reminder.split(':');
                    if (now.getHours() == hours && now.getMinutes() == minutes) {
                        showNotif(`â° Rappel : ${h.name}`);
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('Rappel Habitude', { body: h.name, icon: 'âœ¨' });
                        }
                    }
                }
            });
            
            data.tasks.forEach(t => {
                if (t.reminder && t.reminder === nowStr) {
                    showNotif(`â° Rappel : ${t.title}`);
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Rappel TÃ¢che', { body: t.title, icon: 'ğŸ“‹' });
                    }
                }
            });
        }

async function exportPDF() {
    const container = document.querySelector('.container'); // ton contenu complet
    const canvas = await html2canvas(container, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');

    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

    let heightLeft = pdfHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
    heightLeft -= pdf.internal.pageSize.getHeight();

    while (heightLeft > 0) {
        position = heightLeft - pdfHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();
    }

    pdf.save('rapport.pdf');
}

        function showNotif(msg) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        setInterval(checkReminders, 60000);
        loadData();
        render();
        updateCharts();
    </script>
</body>
</html>


