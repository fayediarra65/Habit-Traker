<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker AvancÃ© Complet</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E8D5C4 0%, #F5E6D8 50%, #E8C4D5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #FFF8F3;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(139, 90, 69, 0.2);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            border-radius: 15px;
            color: white;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #E8D5C4;
            flex-wrap: wrap;
        }
        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #8B5A45;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active { 
            color: #6B4532; 
            border-bottom-color: #C9A58C;
            background: #F5E6D8;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }
        .stat-card .number { font-size: 2.5em; font-weight: bold; }
        .stat-card .label { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .add-section {
            background: #FFF8F3;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #E8D5C4;
        }
        .add-section h3 { color: #8B5A45; margin-bottom: 15px; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: bold; color: #6B4532; font-size: 0.9em; }
        .form-input, .form-select, .form-textarea {
            padding: 10px;
            border: 2px solid #E8D5C4;
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #C9A58C;
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .btn-primary {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        .btn-primary:hover { transform: scale(1.05); }
        .items-grid { display: grid; gap: 15px; margin-bottom: 30px; }
        .item-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1);
            border-left: 5px solid #C9A58C;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .item-title { font-size: 1.2em; font-weight: bold; color: #6B4532; flex: 1; }
        .item-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge-urgent { background: #D98880; color: white; }
        .badge-important { background: #E8C4A0; color: #6B4532; }
        .badge-normal { background: #90C890; color: white; }
        .badge-later { background: #C4D5E8; color: #455566; }
        .badge-daily { background: #E8C4D5; color: #6B4555; }
        .badge-weekly { background: #C4D5E8; color: #455566; }
        .badge-temporary { background: #E8C4A0; color: #6B4532; }
        .item-days {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .day-box {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #C9A58C;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.2s;
            background: white;
        }
        .day-box.checked {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
        }
        .day-box:hover { transform: scale(1.1); }
        .item-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn-small:hover { transform: scale(1.05); }
        .btn-done { background: #90C890; color: white; }
        .btn-edit { background: #C9A58C; color: white; }
        .btn-delete { background: #D98880; color: white; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(139, 90, 69, 0.4);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn {
            padding: 8px 20px;
            border: 2px solid #C9A58C;
            background: white;
            color: #8B5A45;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .filter-btn:hover { transform: scale(1.05); }
        .filter-btn.active { 
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%); 
            color: white; 
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #A0826D;
            font-style: italic;
        }
        .rewards-section {
            background: linear-gradient(135deg, #E8C4A0 0%, #D9B38C 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }
        .rewards-points { font-size: 4em; font-weight: bold; margin: 20px 0; }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .report-stat {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-top: 4px solid #C9A58C;
            box-shadow: 0 2px 8px rgba(139, 90, 69, 0.1);
        }
        
        .report-stat .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #8B5A45;
            margin-bottom: 5px;
        }
        
        .report-stat .label {
            color: #6B4532;
            font-size: 0.9em;
        }
        
        .report-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #C9A58C;
            box-shadow: 0 2px 8px rgba(139, 90, 69, 0.1);
        }
        
        .report-section h3 {
            color: #8B5A45;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .report-item {
            padding: 12px;
            background: #FFF8F3;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-item .item-name {
            font-weight: 600;
            color: #6B4532;
        }
        
        .report-item .item-stat {
            color: #C9A58C;
            font-weight: bold;
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1);
        }
        .chart-box h3 {
            color: #8B5A45;
            margin-bottom: 15px;
            text-align: center;
        }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .charts-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Mon Tracker AvancÃ©</h1>
            <p>Habitudes â€¢ TÃ¢ches â€¢ Objectifs â€¢ Suivi complet</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š Dashboard</button>
            <button class="tab" onclick="switchTab('habits')">âœ¨ Habitudes</button>
            <button class="tab" onclick="switchTab('tasks')">ğŸ“‹ TÃ¢ches</button>
            <button class="tab" onclick="switchTab('goals')">ğŸ¯ Objectifs</button>
            <button class="tab" onclick="switchTab('reports')">ğŸ“ˆ Bilans Hebdo</button>
            <button class="tab" onclick="switchTab('rewards')">ğŸ† RÃ©compenses</button>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="totalPoints">0</div>
                    <div class="label">ğŸ† Points</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="habitsCompleted">0/0</div>
                    <div class="label">âœ¨ Habitudes aujourd'hui</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="tasksCompleted">0/0</div>
                    <div class="label">ğŸ“‹ TÃ¢ches terminÃ©es</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="streak">0</div>
                    <div class="label">ğŸ”¥ SÃ©rie (jours)</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <h3>ğŸ“ˆ Ã‰volution (7 derniers jours)</h3>
                    <canvas id="evolutionChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3>ğŸ¯ RÃ©partition des tÃ¢ches</h3>
                    <canvas id="tasksChart"></canvas>
                </div>
            </div>
        </div>

        <!-- HABITUDES -->
        <div id="habits" class="tab-content">
            <div class="add-section">
                <h3 id="habitFormTitle">â• Ajouter une habitude</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom de l'habitude *</label>
                        <input type="text" id="habitName" class="form-input" placeholder="Ex: Faire du sport">
                    </div>
                    <div class="form-group">
                        <label>FrÃ©quence *</label>
                        <select id="habitType" class="form-select">
                            <option value="daily">Quotidienne</option>
                            <option value="weekly">2-3x par semaine</option>
                            <option value="temporary">Temporaire (pÃ©riode)</option>
                        </select>
                    </div>
                </div>
                <button class="btn-primary" id="habitSubmitBtn" onclick="addHabit()">âœ¨ Ajouter</button>
                <button class="btn-primary" id="habitCancelBtn" onclick="cancelEditHabit()" style="display: none; background: #999;">âŒ Annuler</button>
            </div>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterItems('habits', 'all')">Toutes</button>
                <button class="filter-btn" onclick="filterItems('habits', 'daily')">Quotidiennes</button>
                <button class="filter-btn" onclick="filterItems('habits', 'weekly')">Hebdo</button>
                <button class="filter-btn" onclick="filterItems('habits', 'temporary')">Temporaires</button>
            </div>

            <div class="items-grid" id="habitsList"></div>
        </div>

        <!-- TÃ‚CHES -->
        <div id="tasks" class="tab-content">
            <div class="add-section">
                <h3 id="taskFormTitle">â• Ajouter une tÃ¢che</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Titre *</label>
                        <input type="text" id="taskTitle" class="form-input" placeholder="Ex: Finir le rapport">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="taskType" class="form-select">
                            <option value="work">ğŸ’¼ Professionnel</option>
                            <option value="personal">ğŸ  Personnel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PrioritÃ© *</label>
                        <select id="taskPriority" class="form-select">
                            <option value="urgent">ğŸ”´ Urgent</option>
                            <option value="important">ğŸŸ¡ Important</option>
                            <option value="normal">ğŸŸ¢ Normal</option>
                            <option value="later">ğŸ”µ Plus tard</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="taskNotes" class="form-textarea" placeholder="DÃ©tails..."></textarea>
                </div>
                <button class="btn-primary" id="taskSubmitBtn" onclick="addTask()">ğŸ“‹ Ajouter</button>
                <button class="btn-primary" id="taskCancelBtn" onclick="cancelEditTask()" style="display: none; background: #999;">âŒ Annuler</button>
            </div>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterItems('tasks', 'all')">Toutes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'urgent')">ğŸ”´ Urgentes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'important')">ğŸŸ¡ Importantes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'later')">ğŸ”µ Plus tard</button>
            </div>

            <div class="items-grid" id="tasksList"></div>
        </div>

        <!-- OBJECTIFS -->
        <div id="goals" class="tab-content">
            <div class="add-section">
                <h3 id="goalFormTitle">ğŸ¯ Ajouter un objectif</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Objectif *</label>
                        <input type="text" id="goalTitle" class="form-input" placeholder="Ex: Perdre 10kg">
                    </div>
                    <div class="form-group">
                        <label>CatÃ©gorie</label>
                        <select id="goalCategory" class="form-select">
                            <option value="health">ğŸƒ SantÃ©</option>
                            <option value="career">ğŸ’¼ CarriÃ¨re</option>
                            <option value="learning">ğŸ“š Apprentissage</option>
                            <option value="finance">ğŸ’° Finance</option>
                            <option value="personal">ğŸŒŸ Personnel</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="goalDescription" class="form-textarea" placeholder="DÃ©crivez votre objectif..."></textarea>
                </div>
                <button class="btn-primary" id="goalSubmitBtn" onclick="addGoal()">ğŸ¯ Ajouter</button>
                <button class="btn-primary" id="goalCancelBtn" onclick="cancelEditGoal()" style="display: none; background: #999;">âŒ Annuler</button>
            </div>

            <div class="items-grid" id="goalsList"></div>
        </div>

        <!-- BILANS HEBDOMADAIRES -->
        <div id="reports" class="tab-content">
            <div class="add-section">
                <h3>ğŸ“ˆ Bilans Hebdomadaires (Lundi-Dimanche)</h3>
                <div class="form-group">
                    <label>SÃ©lectionner une semaine</label>
                    <select id="weekSelector" class="form-select" onchange="renderWeeklyReport()" style="font-size: 1.1em;">
                        <option value="">Choisir une semaine...</option>
                    </select>
                </div>
            </div>

            <div id="weeklyReportContent"></div>
        </div>

        <!-- RÃ‰COMPENSES -->
        <div id="rewards" class="tab-content">
            <div class="rewards-section">
                <h2>ğŸ† SystÃ¨me de RÃ©compenses</h2>
                <div class="rewards-points" id="rewardsPoints">0 pts</div>
                <p style="font-size: 1.2em;">Niveau <span id="level">1</span> - <span id="levelName">DÃ©butant</span></p>
                <p style="margin-top: 20px;">âœ¨ +10 pts par habitude complÃ©tÃ©e</p>
                <p>ğŸ“‹ +20 pts par tÃ¢che terminÃ©e</p>
                <p>ğŸ”¥ +50 pts bonus sÃ©rie de 7 jours</p>
                <p>ğŸ¯ +100 pts par objectif atteint</p>
            </div>
        </div>
    </div>

    <script>
        let data = { 
            habits: [], 
            tasks: [], 
            goals: [], 
            points: 0, 
            streak: 0, 
            filter: 'all', 
            editingId: null, 
            editingType: null, 
            history: [] 
        };
        let charts = {};

        async function loadData() {
            try {
                const result = await window.storage.get('tracker_advanced');
                if (result && result.value) {
                    data = JSON.parse(result.value);
                }
            } catch (error) {
                console.log('PremiÃ¨re utilisation');
            }
            populateWeekSelector();
            render();
            updateCharts();
        }

        async function saveData() {
            try {
                await window.storage.set('tracker_advanced', JSON.stringify(data));
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        // BILANS HEBDOMADAIRES
        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            return {
                start: monday.toISOString().split('T')[0],
                end: sunday.toISOString().split('T')[0],
                monday: new Date(monday),
                sunday: new Date(sunday)
            };
        }

        function getAllWeeks() {
            const weeks = [];
            const now = new Date();
            
            for (let i = 0; i < 12; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - (i * 7));
                const week = getWeekRange(d);
                weeks.push(week);
            }
            
            return weeks;
        }

        function populateWeekSelector() {
            const selector = document.getElementById('weekSelector');
            const weeks = getAllWeeks();
            
            selector.innerHTML = '<option value="">Choisir une semaine...</option>';
            
            weeks.forEach((week, idx) => {
                const option = document.createElement('option');
                option.value = week.start;
                const label = `Semaine ${idx === 0 ? 'actuelle' : `il y a ${idx} semaine${idx > 1 ? 's' : ''}`} : ${week.monday.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })} - ${week.sunday.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}`;
                option.textContent = label;
                selector.appendChild(option);
            });
        }

        function renderWeeklyReport() {
            const selector = document.getElementById('weekSelector');
            const startDate = selector.value;
            
            if (!startDate) {
                document.getElementById('weeklyReportContent').innerHTML = '';
                return;
            }
            
            const week = getWeekRange(new Date(startDate));
            const container = document.getElementById('weeklyReportContent');
            
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(week.monday);
                d.setDate(d.getDate() + i);
                weekDays.push(d.toISOString().split('T')[0]);
            }
            
            // Stats habitudes
            let habitsStats = {
                daily: { total: 0, completed: 0 },
                weekly: { total: 0, completed: 0 },
                temporary: { total: 0, completed: 0 }
            };
            
            data.habits.forEach(h => {
                habitsStats[h.type].total++;
                const completedInWeek = weekDays.filter(d => h.days.includes(d)).length;
                if (completedInWeek > 0) habitsStats[h.type].completed++;
            });
            
            // Stats tÃ¢ches par type et prioritÃ©
            const tasksWork = data.tasks.filter(t => t.type === 'work');
            const tasksPersonal = data.tasks.filter(t => t.type === 'personal');
            const tasksWorkCompleted = tasksWork.filter(t => t.completed).length;
            const tasksPersonalCompleted = tasksPersonal.filter(t => t.completed).length;
            
            const tasksByPriority = {
                urgent: data.tasks.filter(t => t.priority === 'urgent'),
                important: data.tasks.filter(t => t.priority === 'important'),
                normal: data.tasks.filter(t => t.priority === 'normal'),
                later: data.tasks.filter(t => t.priority === 'later')
            };
            
            // Stats objectifs
            const goalsCompleted = data.goals.filter(g => g.completed).length;
            const goalsTotal = data.goals.length;
            
            container.innerHTML = `
                <div class="report-summary">
                    <div class="report-stat">
                        <div class="number">${data.points || 0}</div>
                        <div class="label">ğŸ† Points totaux</div>
                    </div>
                    <div class="report-stat">
                        <div class="number">${data.habits.length}</div>
                        <div class="label">âœ¨ Habitudes actives</div>
                    </div>
                    <div class="report-stat">
                        <div class="number">${data.tasks.filter(t => t.completed).length}/${data.tasks.length}</div>
                        <div class="label">ğŸ“‹ TÃ¢ches terminÃ©es</div>
                    </div>
                    <div class="report-stat">
                        <div class="number">${goalsCompleted}/${goalsTotal}</div>
                        <div class="label">ğŸ¯ Objectifs atteints</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>âœ¨ Habitudes par frÃ©quence</h3>
                    <div class="report-item">
                        <span class="item-name">ğŸ“… Quotidiennes</span>
                        <span class="item-stat">${habitsStats.daily.completed}/${habitsStats.daily.total} actives cette semaine</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">ğŸ“† Hebdomadaires (2-3x)</span>
                        <span class="item-stat">${habitsStats.weekly.completed}/${habitsStats.weekly.total} actives cette semaine</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">â³ Temporaires</span>
                        <span class="item-stat">${habitsStats.temporary.completed}/${habitsStats.temporary.total} actives cette semaine</span>
                    </div>
                </div>

                <div class="report-section">
                    <h3>ğŸ“‹ TÃ¢ches par domaine</h3>
                    <div class="report-item">
                        <span class="item-name">ğŸ’¼ Professionnel</span>
                        <span class="item-stat">${tasksWorkCompleted}/${tasksWork.length} terminÃ©es</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">ğŸ  Personnel</span>
                        <span class="item-stat">${tasksPersonalCompleted}/${tasksPersonal.length} terminÃ©es</span>
                    </div>
                </div>

                <div class="report-section">
                    <h3>ğŸ¯ TÃ¢ches par prioritÃ©</h3>
                    ${Object.keys(tasksByPriority).map(priority => {
                        const tasks = tasksByPriority[priority];
                        const completed = tasks.filter(t => t.completed).length;
                        const icon = priority === 'urgent' ? 'ğŸ”´' : priority === 'important' ? 'ğŸŸ¡' : priority === 'normal' ? 'ğŸŸ¢' : 'ğŸ”µ';
                        const label = priority === 'urgent' ? 'Urgentes' : priority === 'important' ? 'Importantes' : priority === 'normal' ? 'Normales' : 'Plus tard';
                        return `
                            <div class="report-item">
                                <span class="item-name">${icon} ${label}</span>
                                <span class="item-stat">${completed}/${tasks.length} terminÃ©es</span>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="report-section">
                    <h3>ğŸ“‹ DÃ©tail des habitudes</h3>
                    ${data.habits.length > 0 ? data.habits.map(h => {
                        const completedInWeek = weekDays.filter(d => h.days.includes(d)).length;
                        return `
                            <div class="report-item">
                                <span class="item-name">${h.name}</span>
                                <span class="item-stat">${completedInWeek}/7 jours cette semaine</span>
                            </div>
                        `;
                    }).join('') : '<p style="text-align: center; color: #A0826D; padding: 20px;">Aucune habitude</p>'}
                </div>

                <div class="report-section">
                    <h3>ğŸ“Š RÃ©capitulatif</h3>
                    <div class="report-item">
                        <span class="item-name">Taux de complÃ©tion tÃ¢ches</span>
                        <span class="item-stat">${data.tasks.length > 0 ? Math.round((data.tasks.filter(t => t.completed).length / data.tasks.length) * 100) : 0}%</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">Taux de complÃ©tion objectifs</span>
                        <span class="item-stat">${goalsTotal > 0 ? Math.round((goalsCompleted / goalsTotal) * 100) : 0}%</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">SÃ©rie actuelle</span>
                        <span class="item-stat">ğŸ”¥ ${calculateStreak()} jours</span>
                    </div>
                </div>
            `;
        }

        // === HABITUDES ===
        function addHabit() {
            const name = document.getElementById('habitName').value.trim();
            if (!name) return showNotif('âš ï¸ Entrez un nom');

            if (data.editingId && data.editingType === 'habit') {
                const habit = data.habits.find(h => h.id === data.editingId);
                habit.name = name;
                habit.type = document.getElementById('habitType').value;
                showNotif('âœï¸ Habitude modifiÃ©e !');
                cancelEditHabit();
            } else {
                data.habits.push({
                    id: Date.now(),
                    name,
                    type: document.getElementById('habitType').value,
                    days: [],
                    completed: 0,
                    createdAt: new Date().toISOString()
                });
                showNotif('âœ¨ Habitude ajoutÃ©e !');
            }

            document.getElementById('habitName').value = '';
            saveData();
            render();
        }

        function editHabit(id) {
            const habit = data.habits.find(h => h.id === id);
            data.editingId = id;
            data.editingType = 'habit';
            
            document.getElementById('habitName').value = habit.name;
            document.getElementById('habitType').value = habit.type;
            
            document.getElementById('habitFormTitle').textContent = 'âœï¸ Modifier l\'habitude';
            document.getElementById('habitSubmitBtn').textContent = 'ğŸ’¾ Enregistrer';
            document.getElementById('habitCancelBtn').style.display = 'inline-block';
        }

        function cancelEditHabit() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('habitName').value = '';
            document.getElementById('habitFormTitle').textContent = 'â• Ajouter une habitude';
            document.getElementById('habitSubmitBtn').textContent = 'âœ¨ Ajouter';
            document.getElementById('habitCancelBtn').style.display = 'none';
        }

        // === TÃ‚CHES ===
        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) return showNotif('âš ï¸ Entrez un titre');

            if (data.editingId && data.editingType === 'task') {
                const task = data.tasks.find(t => t.id === data.editingId);
                task.title = title;
                task.type = document.getElementById('taskType').value;
                task.priority = document.getElementById('taskPriority').value;
                task.notes = document.getElementById('taskNotes').value || '';
                showNotif('âœï¸ TÃ¢che modifiÃ©e !');
                cancelEditTask();
            } else {
                data.tasks.push({
                    id: Date.now(),
                    title,
                    type: document.getElementById('taskType').value,
                    priority: document.getElementById('taskPriority').value,
                    notes: document.getElementById('taskNotes').value || '',
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                showNotif('ğŸ“‹ TÃ¢che ajoutÃ©e !');
            }

            document.getElementById('taskTitle').value = '';
            document.getElementById('taskNotes').value = '';
            saveData();
            render();
        }

        function editTask(id) {
            const task = data.tasks.find(t => t.id === id);
            data.editingId = id;
            data.editingType = 'task';
            
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskType').value = task.type;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskNotes').value = task.notes || '';
            
            document.getElementById('taskFormTitle').textContent = 'âœï¸ Modifier la tÃ¢che';
            document.getElementById('taskSubmitBtn').textContent = 'ğŸ’¾ Enregistrer';
            document.getElementById('taskCancelBtn').style.display = 'inline-block';
        }

        function cancelEditTask() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskNotes').value = '';
            document.getElementById('taskFormTitle').textContent = 'â• Ajouter une tÃ¢che';
            document.getElementById('taskSubmitBtn').textContent = 'ğŸ“‹ Ajouter';
            document.getElementById('taskCancelBtn').style.display = 'none';
        }

        // === OBJECTIFS ===
        function addGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            if (!title) return showNotif('âš ï¸ Entrez un objectif');

            if (data.editingId && data.editingType === 'goal') {
                const goal = data.goals.find(g => g.id === data.editingId);
                goal.title = title;
                goal.category = document.getElementById('goalCategory').value;
                goal.description = document.getElementById('goalDescription').value || '';
                showNotif('âœï¸ Objectif modifiÃ© !');
                cancelEditGoal();
            } else {
                data.goals.push({
                    id: Date.now(),
                    title,
                    category: document.getElementById('goalCategory').value,
                    description: document.getElementById('goalDescription').value || '',
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                showNotif('ğŸ¯ Objectif ajoutÃ© !');
            }

            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDescription').value = '';
            saveData();
            render();
        }

        function editGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            data.editingId = id;
            data.editingType = 'goal';
            
            document.getElementById('goalTitle').value = goal.title;
            document.getElementById('goalCategory').value = goal.category;
            document.getElementById('goalDescription').value = goal.description || '';
            
            document.getElementById('goalFormTitle').textContent = 'âœï¸ Modifier l\'objectif';
            document.getElementById('goalSubmitBtn').textContent = 'ğŸ’¾ Enregistrer';
            document.getElementById('goalCancelBtn').style.display = 'inline-block';
        }

        function cancelEditGoal() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDescription').value = '';
            document.getElementById('goalFormTitle').textContent = 'ğŸ¯ Ajouter un objectif';
            document.getElementById('goalSubmitBtn').textContent = 'ğŸ¯ Ajouter';
            document.getElementById('goalCancelBtn').style.display = 'none';
        }

        function toggleGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            goal.completed = !goal.completed;
            if (goal.completed) {
                data.points += 100;
                showNotif('ğŸ‰ Objectif atteint ! +100 points');
            } else {
                data.points -= 100;
            }
            saveData();
            render();
        }

        function toggleDay(habitId, day) {
            const habit = data.habits.find(h => h.id === habitId);
            const idx = habit.days.indexOf(day);
            
            if (idx > -1) {
                habit.days.splice(idx, 1);
                habit.completed--;
                data.points -= 10;
                showNotif('â†©ï¸ -10 points');
            } else {
                habit.days.push(day);
                habit.completed++;
                data.points += 10;
                showNotif('âœ¨ +10 points !');
            }
            
            trackHistory('habit', habitId, idx > -1 ? 'unchecked' : 'checked');
            saveData();
            render();
            updateCharts();
        }

        function toggleTask(id) {
            const task = data.tasks.find(t => t.id === id);
            task.completed = !task.completed;
            
            if (task.completed) {
                task.completedAt = new Date().toISOString();
                data.points += 20;
                showNotif('ğŸ‰ +20 points !');
            } else {
                task.completedAt = null;
                data.points -= 20;
                showNotif('â†©ï¸ -20 points');
            }
            
            trackHistory('task', id, task.completed ? 'completed' : 'uncompleted');
            saveData();
            render();
            updateCharts();
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const days = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
            const months = ['janv.', 'fÃ©vr.', 'mars', 'avr.', 'mai', 'juin', 'juil.', 'aoÃ»t', 'sept.', 'oct.', 'nov.', 'dÃ©c.'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${dayName} ${day} ${month} ${year}, ${hours}:${minutes}`;
        }

        function deleteItem(type, id) {
            if (type === 'habit') {
                data.habits = data.habits.filter(item => item.id !== id);
            } else if (type === 'task') {
                data.tasks = data.tasks.filter(item => item.id !== id);
            } else if (type === 'goal') {
                data.goals = data.goals.filter(item => item.id !== id);
            }
            
            showNotif('ğŸ—‘ï¸ SupprimÃ© !');
            saveData();
            render();
            updateCharts();
        }

        function filterItems(type, filter) {
            data.filter = filter;
            const parent = event.target.parentElement;
            parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }

        function trackHistory(type, id, action) {
            const today = new Date().toISOString().split('T')[0];
            if (!data.history) data.history = [];
            data.history.push({ type, id, action, date: today });
            if (data.history.length > 100) data.history.shift();
        }

        function getWeekDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - d.getDay() + i + 1);
                days.push(d.toISOString().split('T')[0]);
            }
            return days;
        }

        function render() {
            const weekDays = getWeekDays();
            const dayNames = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];

            let filteredHabits = data.habits;
            let filteredTasks = data.tasks;
            let filteredGoals = data.goals;

            if (data.filter !== 'all') {
                filteredHabits = data.habits.filter(h => h.type === data.filter);
                filteredTasks = data.tasks.filter(t => t.priority === data.filter || t.type === data.filter);
            }

            // HABITUDES
            document.getElementById('habitsList').innerHTML = filteredHabits.length ? filteredHabits.map(h => `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-title">${h.name}</div>
                        <span class="item-badge badge-${h.type}">${
                            h.type === 'daily' ? 'Quotidienne' :
                            h.type === 'weekly' ? 'Hebdo' : 'Temporaire'
                        }</span>
                    </div>
                    <div class="item-days">
                        ${weekDays.map((day, i) => `
                            <div class="day-box ${h.days.includes(day) ? 'checked' : ''}" 
                                 onclick="toggleDay(${h.id}, '${day}')">
                                ${dayNames[i]}
                            </div>
                        `).join('')}
                    </div>
                    <p style="color: #666; margin-top: 10px;">âœ… ${h.completed || 0} fois complÃ©tÃ©e</p>
                    <div class="item-actions">
                        <button class="btn-small btn-edit" onclick="editHabit(${h.id})">âœï¸ Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('habit', ${h.id})">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">ğŸ“­ Aucune habitude</div>';

            // TÃ‚CHES
            document.getElementById('tasksList').innerHTML = filteredTasks.length ? filteredTasks.map(t => `
                <div class="item-card" style="${t.completed ? 'opacity: 0.6;' : ''}">
                    <div class="item-header">
                        <div class="item-title" style="${t.completed ? 'text-decoration: line-through;' : ''}">${t.title}</div>
                        <span class="item-badge badge-${t.priority}">${
                            t.priority === 'urgent' ? 'ğŸ”´ Urgent' :
                            t.priority === 'important' ? 'ğŸŸ¡ Important' :
                            t.priority === 'normal' ? 'ğŸŸ¢ Normal' : 'ğŸ”µ Plus tard'
                        }</span>
                    </div>
                    <p style="color: #666; margin: 10px 0;">${t.type === 'work' ? 'ğŸ’¼ Pro' : 'ğŸ  Perso'}</p>
                    ${t.notes ? `<p style="color: #666; font-style: italic; margin-top: 10px;">${t.notes}</p>` : ''}
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #E8D5C4;">
                        <p style="color: #8B5A45; font-size: 0.85em; margin-bottom: 5px;">
                            ğŸ“… <strong>CrÃ©Ã©e le :</strong> ${formatDate(t.createdAt)}
                        </p>
                        ${t.completed && t.completedAt ? `
                            <p style="color: #90C890; font-size: 0.85em;">
                                âœ… <strong>Accomplie le :</strong> ${formatDate(t.completedAt)}
                            </p>
                        ` : ''}
                    </div>
                    <div class="item-actions">
                        <button class="btn-small btn-done" onclick="toggleTask(${t.id})">
                            ${t.completed ? 'â†©ï¸ RÃ©activer' : 'âœ… Terminer'}
                        </button>
                        <button class="btn-small btn-edit" onclick="editTask(${t.id})">âœï¸ Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('task', ${t.id})">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">ğŸ“­ Aucune tÃ¢che</div>';

            // OBJECTIFS
            document.getElementById('goalsList').innerHTML = filteredGoals.length ? filteredGoals.map(g => `
                <div class="item-card" style="${g.completed ? 'opacity: 0.6;' : ''}">
                    <div class="item-header">
                        <div class="item-title" style="${g.completed ? 'text-decoration: line-through;' : ''}">${g.title}</div>
                        <span class="item-badge badge-normal">${
                            g.category === 'health' ? 'ğŸƒ SantÃ©' :
                            g.category === 'career' ? 'ğŸ’¼ CarriÃ¨re' :
                            g.category === 'learning' ? 'ğŸ“š Apprentissage' :
                            g.category === 'finance' ? 'ğŸ’° Finance' : 'ğŸŒŸ Personnel'
                        }</span>
                    </div>
                    ${g.description ? `<p style="color: #666; font-style: italic;">${g.description}</p>` : ''}
                    <div class="item-actions">
                        <button class="btn-small btn-done" onclick="toggleGoal(${g.id})">
                            ${g.completed ? 'â†©ï¸ RÃ©activer' : 'âœ… Atteint'}
                        </button>
                        <button class="btn-small btn-edit" onclick="editGoal(${g.id})">âœï¸ Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('goal', ${g.id})">ğŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">ğŸ“­ Aucun objectif</div>';

            updateStats();
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const completedToday = data.habits.filter(h => h.days.includes(today)).length;
            const completedTasks = data.tasks.filter(t => t.completed).length;

            document.getElementById('totalPoints').textContent = data.points || 0;
            document.getElementById('habitsCompleted').textContent = `${completedToday}/${data.habits.length}`;
            document.getElementById('tasksCompleted').textContent = `${completedTasks}/${data.tasks.length}`;
            document.getElementById('streak').textContent = calculateStreak();
            document.getElementById('rewardsPoints').textContent = (data.points || 0) + ' pts';

            const level = Math.floor((data.points || 0) / 100) + 1;
            const levelNames = ['DÃ©butant', 'MotivÃ©', 'RÃ©gulier', 'Expert', 'MaÃ®tre', 'LÃ©gende'];
            document.getElementById('level').textContent = level;
            document.getElementById('levelName').textContent = levelNames[Math.min(level - 1, 5)];
        }

        function calculateStreak() {
            if (!data.history || data.history.length === 0) return 0;
            
            let streak = 0;
            let currentDate = new Date();
            
            for (let i = 0; i < 30; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const hasActivity = data.history.some(h => h.date === dateStr && h.action === 'checked');
                
                if (hasActivity) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function updateCharts() {
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toISOString().split('T')[0]);
            }

            const habitsData = last7Days.map(day => 
                data.habits.filter(h => h.days.includes(day)).length
            );

            const tasksData = last7Days.map(day => 
                data.tasks.filter(t => t.completed && t.createdAt && t.createdAt.startsWith(day)).length
            );

            if (charts.evolution) charts.evolution.destroy();
            const ctx1 = document.getElementById('evolutionChart').getContext('2d');
            charts.evolution = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => new Date(d).toLocaleDateString('fr', { weekday: 'short' })),
                    datasets: [{
                        label: 'Habitudes',
                        data: habitsData,
                        borderColor: '#C9A58C',
                        backgroundColor: 'rgba(201, 165, 140, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'TÃ¢ches',
                        data: tasksData,
                        borderColor: '#B8967E',
                        backgroundColor: 'rgba(184, 150, 126, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });

            if (charts.tasks) charts.tasks.destroy();
            const ctx2 = document.getElementById('tasksChart').getContext('2d');
            const urgentTasks = data.tasks.filter(t => t.priority === 'urgent').length;
            const importantTasks = data.tasks.filter(t => t.priority === 'important').length;
            const normalTasks = data.tasks.filter(t => t.priority === 'normal').length;
            const laterTasks = data.tasks.filter(t => t.priority === 'later').length;

            charts.tasks = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Urgentes', 'Importantes', 'Normales', 'Plus tard'],
                    datasets: [{
                        data: [urgentTasks, importantTasks, normalTasks, laterTasks],
                        backgroundColor: ['#D98880', '#E8C4A0', '#90C890', '#C4D5E8']
                    }]
                },
                options: { responsive: true }
            });
        }

        function showNotif(msg) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        loadData();
    </script>
</body>
</html>
