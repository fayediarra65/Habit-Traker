<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Avanc√© Complet</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E8D5C4 0%, #F5E6D8 50%, #E8C4D5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #FFF8F3;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(139, 90, 69, 0.2);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            border-radius: 15px;
            color: white;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #E8D5C4;
            flex-wrap: wrap;
        }
        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #8B5A45;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active { 
            color: #6B4532; 
            border-bottom-color: #C9A58C;
            background: #F5E6D8;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }
        .stat-card.habits-card {
            background: linear-gradient(135deg, #74B9FF 0%, #5DADE2 100%);
        }
        .stat-card.tasks-card {
            background: linear-gradient(135deg, #81C784 0%, #66BB6A 100%);
        }
        .stat-card .number { font-size: 2.5em; font-weight: bold; }
        .stat-card .label { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .add-section {
            background: #FFF8F3;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #E8D5C4;
        }
        .add-section h3 { color: #8B5A45; margin-bottom: 15px; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: bold; color: #6B4532; font-size: 0.9em; }
        .form-input, .form-select, .form-textarea {
            padding: 10px;
            border: 2px solid #E8D5C4;
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #C9A58C;
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .btn-primary {
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        .btn-primary:hover { transform: scale(1.05); }
        .items-grid { display: grid; gap: 15px; margin-bottom: 30px; }
        .item-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1);
            border-left: 5px solid #C9A58C;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .item-title { font-size: 1.2em; font-weight: bold; color: #6B4532; flex: 1; }
        .item-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge-urgent { background: #D98880; color: white; }
        .badge-important { background: #E8C4A0; color: #6B4532; }
        .badge-normal { background: #90C890; color: white; }
        .badge-later { background: #C4D5E8; color: #455566; }
        .badge-daily { background: #E8C4D5; color: #6B4555; }
        .badge-weekly { background: #C4D5E8; color: #455566; }
        .badge-temporary { background: #E8C4A0; color: #6B4532; }
        .item-days {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .day-box {
            min-width: 60px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #C9A58C;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75em;
            transition: all 0.2s;
            background: white;
            padding: 5px;
        }
        .day-box .day-letter {
            font-size: 0.9em;
            opacity: 0.7;
        }
        .day-box .day-date {
            font-size: 1.1em;
            margin-top: 2px;
        }
        .month-section {
            background: #FFF8F3;
            border: 2px solid #E8D5C4;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .month-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #E8D5C4 0%, #D9C4B5 100%);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #6B4532;
            transition: all 0.3s;
        }
        .month-header:hover {
            background: linear-gradient(135deg, #D9C4B5 0%, #C9B4A5 100%);
        }
        .month-toggle {
            font-size: 1.2em;
            transition: transform 0.3s;
        }
        .month-section.collapsed .month-toggle {
            transform: rotate(-90deg);
        }
        .month-section.collapsed .month-content {
            display: none;
        }
        .month-content {
            padding: 15px;
        }
        .item-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn-small:hover { transform: scale(1.05); }
        .btn-done { background: #90C890; color: white; }
        .btn-edit { background: #C9A58C; color: white; }
        .btn-delete { background: #D98880; color: white; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(139, 90, 69, 0.4);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn {
            padding: 8px 20px;
            border: 2px solid #C9A58C;
            background: white;
            color: #8B5A45;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .filter-btn:hover { transform: scale(1.05); }
        .filter-btn.active { 
            background: linear-gradient(135deg, #C9A58C 0%, #B8967E 100%); 
            color: white; 
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #A0826D;
            font-style: italic;
        }
        .rewards-section {
            background: linear-gradient(135deg, #E8C4A0 0%, #D9B38C 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
        }
        .rewards-points { font-size: 4em; font-weight: bold; margin: 20px 0; }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .report-stat {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-top: 4px solid #C9A58C;
            box-shadow: 0 2px 8px rgba(139, 90, 69, 0.1);
        }
        
        .report-stat .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #8B5A45;
            margin-bottom: 5px;
        }
        
        .report-stat .label {
            color: #6B4532;
            font-size: 0.9em;
        }
        
        .report-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #C9A58C;
            box-shadow: 0 2px 8px rgba(139, 90, 69, 0.1);
        }
        
        .report-section h3 {
            color: #8B5A45;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .report-item {
            padding: 12px;
            background: #FFF8F3;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-item .item-name {
            font-weight: 600;
            color: #6B4532;
        }
        
        .report-item .item-stat {
            color: #C9A58C;
            font-weight: bold;
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1);
        }
        .chart-box h3 {
            color: #8B5A45;
            margin-bottom: 15px;
            text-align: center;
        }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .charts-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Mon Tracker Avanc√©</h1>
            <p>Habitudes ‚Ä¢ T√¢ches ‚Ä¢ Objectifs ‚Ä¢ Suivi complet</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('habits')">‚ú® Habitudes</button>
            <button class="tab" onclick="switchTab('tasks')">üìã T√¢ches</button>
            <button class="tab" onclick="switchTab('goals')">üéØ Objectifs</button>
            <button class="tab" onclick="switchTab('reports')">üìà Bilans Hebdo</button>
            <button class="tab" onclick="switchTab('rewards')">üèÜ R√©compenses</button>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="totalPoints">0</div>
                    <div class="label">üèÜ Points</div>
                </div>
                <div class="stat-card habits-card">
                    <div class="number" id="habitsCompleted">0/0</div>
                    <div class="label">‚ú® Habitudes aujourd'hui</div>
                </div>
                <div class="stat-card tasks-card">
                    <div class="number" id="tasksCompleted">0/0</div>
                    <div class="label">üìã T√¢ches termin√©es</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="streak">0</div>
                    <div class="label">üî• S√©rie (jours)</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <h3>üìà √âvolution (7 derniers jours)</h3>
                    <canvas id="evolutionChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3>üéØ R√©partition des t√¢ches</h3>
                    <canvas id="tasksChart"></canvas>
                </div>
            </div>
        </div>

        <!-- HABITUDES -->
        <div id="habits" class="tab-content">
            <div class="add-section">
                <h3 id="habitFormTitle">‚ûï Ajouter une habitude</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom de l'habitude *</label>
                        <input type="text" id="habitName" class="form-input" placeholder="Ex: Faire du sport">
                    </div>
                    <div class="form-group">
                        <label>Fr√©quence *</label>
                        <select id="habitType" class="form-select">
                            <option value="daily">Quotidienne</option>
                            <option value="weekly">2-3x par semaine</option>
                            <option value="temporary">Temporaire (p√©riode)</option>
                        </select>
                    </div>
                </div>
                <button class="btn-primary" id="habitSubmitBtn" onclick="addHabit()">‚ú® Ajouter</button>
                <button class="btn-primary" id="habitCancelBtn" onclick="cancelEditHabit()" style="display: none; background: #999;">‚ùå Annuler</button>
            </div>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterItems('habits', 'all')">Toutes</button>
                <button class="filter-btn" onclick="filterItems('habits', 'daily')">Quotidiennes</button>
                <button class="filter-btn" onclick="filterItems('habits', 'weekly')">Hebdo</button>
                <button class="filter-btn" onclick="filterItems('habits', 'temporary')">Temporaires</button>
            </div>

            <div class="items-grid" id="habitsList"></div>
        </div>

        <!-- T√ÇCHES -->
        <div id="tasks" class="tab-content">
            <div class="add-section">
                <h3 id="taskFormTitle">‚ûï Ajouter une t√¢che</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Titre *</label>
                        <input type="text" id="taskTitle" class="form-input" placeholder="Ex: Finir le rapport">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="taskType" class="form-select">
                            <option value="work">üíº Professionnel</option>
                            <option value="personal">üè† Personnel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priorit√© *</label>
                        <select id="taskPriority" class="form-select">
                            <option value="urgent">üî¥ Urgent</option>
                            <option value="important">üü° Important</option>
                            <option value="normal">üü¢ Normal</option>
                            <option value="later">üîµ Plus tard</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="taskNotes" class="form-textarea" placeholder="D√©tails..."></textarea>
                </div>
                <button class="btn-primary" id="taskSubmitBtn" onclick="addTask()">üìã Ajouter</button>
                <button class="btn-primary" id="taskCancelBtn" onclick="cancelEditTask()" style="display: none; background: #999;">‚ùå Annuler</button>
            </div>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterItems('tasks', 'all')">Toutes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'urgent')">üî¥ Urgentes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'important')">üü° Importantes</button>
                <button class="filter-btn" onclick="filterItems('tasks', 'later')">üîµ Plus tard</button>
            </div>

            <div class="items-grid" id="tasksList"></div>
        </div>

        <!-- OBJECTIFS -->
        <div id="goals" class="tab-content">
            <div class="add-section">
                <h3 id="goalFormTitle">üéØ Ajouter un objectif</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Objectif *</label>
                        <input type="text" id="goalTitle" class="form-input" placeholder="Ex: Perdre 10kg">
                    </div>
                    <div class="form-group">
                        <label>Cat√©gorie</label>
                        <select id="goalCategory" class="form-select">
                            <option value="health">üèÉ Sant√©</option>
                            <option value="career">üíº Carri√®re</option>
                            <option value="learning">üìö Apprentissage</option>
                            <option value="finance">üí∞ Finance</option>
                            <option value="personal">üåü Personnel</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="goalDescription" class="form-textarea" placeholder="D√©crivez votre objectif..."></textarea>
                </div>
                <button class="btn-primary" id="goalSubmitBtn" onclick="addGoal()">üéØ Ajouter</button>
                <button class="btn-primary" id="goalCancelBtn" onclick="cancelEditGoal()" style="display: none; background: #999;">‚ùå Annuler</button>
            </div>

            <div class="items-grid" id="goalsList"></div>
        </div>

        <!-- BILANS HEBDOMADAIRES -->
        <div id="reports" class="tab-content">
            <div class="add-section">
                <h3>üìà Bilans Hebdomadaires (Lundi-Dimanche)</h3>
                <div class="form-group">
                    <label>S√©lectionner une semaine</label>
                    <select id="weekSelector" class="form-select" onchange="renderWeeklyReport()" style="font-size: 1.1em;">
                        <option value="">Choisir une semaine...</option>
                    </select>
                </div>
            </div>

            <div id="weeklyReportContent"></div>
        </div>

        <!-- R√âCOMPENSES -->
        <div id="rewards" class="tab-content">
            <div class="rewards-section">
                <h2>üèÜ Syst√®me de R√©compenses</h2>
                <div class="rewards-points" id="rewardsPoints">0 pts</div>
                <p style="font-size: 1.2em;">Niveau <span id="level">1</span> - <span id="levelName">D√©butant</span></p>
                <p style="margin-top: 20px;">‚ú® +10 pts par habitude compl√©t√©e</p>
                <p>üìã +20 pts par t√¢che termin√©e</p>
                <p>üî• +50 pts bonus s√©rie de 7 jours</p>
                <p>üéØ +100 pts par objectif atteint</p>
            </div>
        </div>
    </div>

    <script>
        let data = { 
            habits: [], 
            tasks: [], 
            goals: [], 
            points: 0, 
            streak: 0, 
            filter: 'all', 
            editingId: null, 
            editingType: null, 
            history: [],
            habitView: 'week' // 'week' ou 'history'
        };
        let charts = {};

        function toggleHabitView(view) {
            data.habitView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }

        function toggleMonth(element) {
            element.closest('.month-section').classList.toggle('collapsed');
        }

        function getMonthsFromHabits() {
            const months = new Set();
            data.habits.forEach(habit => {
                habit.days.forEach(day => {
                    const date = new Date(day);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(monthKey);
                });
            });
            return Array.from(months).sort().reverse();
        }

        function getMonthName(monthKey) {
            const [year, month] = monthKey.split('-');
            const date = new Date(year, parseInt(month) - 1);
            const monthNames = ['janv.', 'f√©vr.', 'mars', 'avr.', 'mai', 'juin', 'juil.', 'ao√ªt', 'sept.', 'oct.', 'nov.', 'd√©c.'];
            return `${monthNames[date.getMonth()]} ${year}`;
        }

        function getDaysInMonth(monthKey) {
            const [year, month] = monthKey.split('-');
            const firstDay = new Date(year, parseInt(month) - 1, 1);
            const lastDay = new Date(year, parseInt(month), 0);
            const days = [];
            
            for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                days.push(new Date(d).toISOString().split('T')[0]);
            }
            
            return days;
        }

        function formatDayBox(dateStr) {
            const date = new Date(dateStr);
            const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
            const dayLetter = dayNames[date.getDay()];
            const dayNumber = date.getDate();
            
            return { letter: dayLetter, number: dayNumber };
        }

        async function loadData() {
            // Essai 1 : window.storage (stockage persistant Claude)
            try {
                const result = await window.storage.get('tracker_advanced');
                if (result && result.value) {
                    const loaded = JSON.parse(result.value);
                    data = {
                        habits: loaded.habits || [],
                        tasks: loaded.tasks || [],
                        goals: loaded.goals || [],
                        points: loaded.points || 0,
                        streak: loaded.streak || 0,
                        filter: loaded.filter || 'all',
                        editingId: null,
                        editingType: null,
                        history: loaded.history || []
                    };
                    console.log('‚úÖ Donn√©es charg√©es depuis window.storage');
                    populateWeekSelector();
                    render();
                    updateCharts();
                    return;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è window.storage non disponible:', error);
            }

            // Essai 2 : localStorage (stockage navigateur)
            try {
                const localData = localStorage.getItem('tracker_advanced');
                if (localData) {
                    const loaded = JSON.parse(localData);
                    data = {
                        habits: loaded.habits || [],
                        tasks: loaded.tasks || [],
                        goals: loaded.goals || [],
                        points: loaded.points || 0,
                        streak: loaded.streak || 0,
                        filter: loaded.filter || 'all',
                        editingId: null,
                        editingType: null,
                        history: loaded.history || []
                    };
                    console.log('‚úÖ Donn√©es charg√©es depuis localStorage');
                    populateWeekSelector();
                    render();
                    updateCharts();
                    return;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è localStorage non disponible:', error);
            }

            // Initialisation par d√©faut
            console.log('üì¶ Premi√®re utilisation - donn√©es vierges');
            populateWeekSelector();
            render();
            updateCharts();
        }

        async function saveData() {
            const dataToSave = {
                habits: data.habits,
                tasks: data.tasks,
                goals: data.goals,
                points: data.points,
                streak: data.streak,
                filter: data.filter,
                history: data.history,
                lastSaved: new Date().toISOString()
            };
            const jsonData = JSON.stringify(dataToSave);
            
            let savedToCloud = false;
            let savedToLocal = false;

            // Sauvegarde 1 : window.storage (prioritaire)
            try {
                const result = await window.storage.set('tracker_advanced', jsonData);
                if (result) {
                    savedToCloud = true;
                    console.log('üíæ Sauvegard√© dans window.storage');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è √âchec window.storage:', error);
            }

            // Sauvegarde 2 : localStorage (backup)
            try {
                localStorage.setItem('tracker_advanced', jsonData);
                savedToLocal = true;
                console.log('üíæ Sauvegard√© dans localStorage');
            } catch (error) {
                console.warn('‚ö†Ô∏è √âchec localStorage:', error);
            }

            // Notification silencieuse
            if (!savedToCloud && !savedToLocal) {
                console.error('‚ùå √âCHEC DE SAUVEGARDE CRITIQUE');
                showNotif('‚ö†Ô∏è √âchec de sauvegarde !');
                return false;
            }
            
            return true;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        // BILANS HEBDOMADAIRES
        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            return {
                start: monday.toISOString().split('T')[0],
                end: sunday.toISOString().split('T')[0],
                monday: new Date(monday),
                sunday: new Date(sunday)
            };
        }

        function getAllWeeks() {
            const weeks = [];
            const now = new Date();
            
            for (let i = 0; i < 12; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - (i * 7));
                const week = getWeekRange(d);
                weeks.push(week);
            }
            
            return weeks;
        }

        function populateWeekSelector() {
            const selector = document.getElementById('weekSelector');
            const weeks = getAllWeeks();
            
            selector.innerHTML = '<option value="">Choisir une semaine...</option>';
            
            weeks.forEach((week, idx) => {
                const option = document.createElement('option');
                option.value = week.start;
                const label = `Semaine ${idx === 0 ? 'actuelle' : `il y a ${idx} semaine${idx > 1 ? 's' : ''}`} : ${week.monday.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })} - ${week.sunday.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}`;
                option.textContent = label;
                selector.appendChild(option);
            });
        }

        function renderWeeklyReport() {
            const selector = document.getElementById('weekSelector');
            const startDate = selector.value;
            
            if (!startDate) {
                document.getElementById('weeklyReportContent').innerHTML = '';
                return;
            }
            
            const week = getWeekRange(new Date(startDate));
            const container = document.getElementById('weeklyReportContent');
            
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(week.monday);
                d.setDate(d.getDate() + i);
                weekDays.push(d.toISOString().split('T')[0]);
            }
            
            // Stats habitudes
            let habitsStats = {
                daily: { total: 0, completed: 0 },
                weekly: { total: 0, completed: 0 },
                temporary: { total: 0, completed: 0 }
            };
            
            data.habits.forEach(h => {
                habitsStats[h.type].total++;
                const completedInWeek = weekDays.filter(d => h.days.includes(d)).length;
                if (completedInWeek > 0) habitsStats[h.type].completed++;
            });
            
            // Stats t√¢ches par type et priorit√©
            const tasksWork = data.tasks.filter(t => t.type === 'work');
            const tasksPersonal = data.tasks.filter(t => t.type === 'personal');
            const tasksWorkCompleted = tasksWork.filter(t => t.completed).length;
            const tasksPersonalCompleted = tasksPersonal.filter(t => t.completed).length;
            
            const tasksByPriority = {
                urgent: data.tasks.filter(t => t.priority === 'urgent'),
                important: data.tasks.filter(t => t.priority === 'important'),
                normal: data.tasks.filter(t => t.priority === 'normal'),
                later: data.tasks.filter(t => t.priority === 'later')
            };
            
            // Stats objectifs
            const goalsCompleted = data.goals.filter(g => g.completed).length;
            const goalsTotal = data.goals.length;
            
            container.innerHTML = `
                <div class="report-summary">
                    <div class="report-stat">
                        <div class="number">${data.points || 0}</div>
                        <div class="label">üèÜ Points totaux</div>
                    </div>
                    <div class="report-stat">
                        <div class="number">${data.habits.length}</div>
                        <div class="label">‚ú® Habitudes actives</div>
                    </div>
                    <div class="report-stat">
                        <div class="number">${data.tasks.filter(t => t.completed).length}/${data.tasks.length}</div>
                        <div class="label">üìã T√¢ches termin√©es</div>
                    </div>
                    <div class="report-stat">
                        <div class="number">${goalsCompleted}/${goalsTotal}</div>
                        <div class="label">üéØ Objectifs atteints</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>‚ú® Habitudes par fr√©quence</h3>
                    <div class="report-item">
                        <span class="item-name">üìÖ Quotidiennes</span>
                        <span class="item-stat">${habitsStats.daily.completed}/${habitsStats.daily.total} actives cette semaine</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">üìÜ Hebdomadaires (2-3x)</span>
                        <span class="item-stat">${habitsStats.weekly.completed}/${habitsStats.weekly.total} actives cette semaine</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">‚è≥ Temporaires</span>
                        <span class="item-stat">${habitsStats.temporary.completed}/${habitsStats.temporary.total} actives cette semaine</span>
                    </div>
                </div>

                <div class="report-section">
                    <h3>üìã T√¢ches par domaine</h3>
                    <div class="report-item">
                        <span class="item-name">üíº Professionnel</span>
                        <span class="item-stat">${tasksWorkCompleted}/${tasksWork.length} termin√©es</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">üè† Personnel</span>
                        <span class="item-stat">${tasksPersonalCompleted}/${tasksPersonal.length} termin√©es</span>
                    </div>
                </div>

                <div class="report-section">
                    <h3>üéØ T√¢ches par priorit√©</h3>
                    ${Object.keys(tasksByPriority).map(priority => {
                        const tasks = tasksByPriority[priority];
                        const completed = tasks.filter(t => t.completed).length;
                        const icon = priority === 'urgent' ? 'üî¥' : priority === 'important' ? 'üü°' : priority === 'normal' ? 'üü¢' : 'üîµ';
                        const label = priority === 'urgent' ? 'Urgentes' : priority === 'important' ? 'Importantes' : priority === 'normal' ? 'Normales' : 'Plus tard';
                        return `
                            <div class="report-item">
                                <span class="item-name">${icon} ${label}</span>
                                <span class="item-stat">${completed}/${tasks.length} termin√©es</span>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="report-section">
                    <h3>üìã D√©tail des habitudes</h3>
                    ${data.habits.length > 0 ? data.habits.map(h => {
                        const completedInWeek = weekDays.filter(d => h.days.includes(d)).length;
                        return `
                            <div class="report-item">
                                <span class="item-name">${h.name}</span>
                                <span class="item-stat">${completedInWeek}/7 jours cette semaine</span>
                            </div>
                        `;
                    }).join('') : '<p style="text-align: center; color: #A0826D; padding: 20px;">Aucune habitude</p>'}
                </div>

                <div class="report-section">
                    <h3>üìä R√©capitulatif</h3>
                    <div class="report-item">
                        <span class="item-name">Taux de compl√©tion t√¢ches</span>
                        <span class="item-stat">${data.tasks.length > 0 ? Math.round((data.tasks.filter(t => t.completed).length / data.tasks.length) * 100) : 0}%</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">Taux de compl√©tion objectifs</span>
                        <span class="item-stat">${goalsTotal > 0 ? Math.round((goalsCompleted / goalsTotal) * 100) : 0}%</span>
                    </div>
                    <div class="report-item">
                        <span class="item-name">S√©rie actuelle</span>
                        <span class="item-stat">üî• ${calculateStreak()} jours</span>
                    </div>
                </div>
            `;
        }

        function addHabit() {
            const name = document.getElementById('habitName').value.trim();
            if (!name) return showNotif('‚ö†Ô∏è Entrez un nom');

            if (data.editingId && data.editingType === 'habit') {
                const habit = data.habits.find(h => h.id === data.editingId);
                habit.name = name;
                habit.type = document.getElementById('habitType').value;
                showNotif('‚úèÔ∏è Habitude modifi√©e !');
                cancelEditHabit();
            } else {
                const newHabit = {
                    id: Date.now(),
                    name,
                    type: document.getElementById('habitType').value,
                    days: [],
                    completed: 0,
                    createdAt: new Date().toISOString()
                };
                data.habits.push(newHabit);
                console.log('‚ú® Nouvelle habitude ajout√©e:', newHabit);
                showNotif('‚ú® Habitude ajout√©e !');
            }

            document.getElementById('habitName').value = '';
            
            // Sauvegarder et afficher imm√©diatement
            saveData().then(() => {
                console.log('üíæ Habitude sauvegard√©e, affichage...');
                render();
                updateCharts();
            });
        }

        function editHabit(id) {
            const habit = data.habits.find(h => h.id === id);
            data.editingId = id;
            data.editingType = 'habit';
            
            document.getElementById('habitName').value = habit.name;
            document.getElementById('habitType').value = habit.type;
            
            document.getElementById('habitFormTitle').textContent = '‚úèÔ∏è Modifier l\'habitude';
            document.getElementById('habitSubmitBtn').textContent = 'üíæ Enregistrer';
            document.getElementById('habitCancelBtn').style.display = 'inline-block';
        }

        function cancelEditHabit() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('habitName').value = '';
            document.getElementById('habitFormTitle').textContent = '‚ûï Ajouter une habitude';
            document.getElementById('habitSubmitBtn').textContent = '‚ú® Ajouter';
            document.getElementById('habitCancelBtn').style.display = 'none';
        }

        // === T√ÇCHES ===
        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) return showNotif('‚ö†Ô∏è Entrez un titre');

            if (data.editingId && data.editingType === 'task') {
                const task = data.tasks.find(t => t.id === data.editingId);
                task.title = title;
                task.type = document.getElementById('taskType').value;
                task.priority = document.getElementById('taskPriority').value;
                task.notes = document.getElementById('taskNotes').value || '';
                showNotif('‚úèÔ∏è T√¢che modifi√©e !');
                cancelEditTask();
            } else {
                data.tasks.push({
                    id: Date.now(),
                    title,
                    type: document.getElementById('taskType').value,
                    priority: document.getElementById('taskPriority').value,
                    notes: document.getElementById('taskNotes').value || '',
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                showNotif('üìã T√¢che ajout√©e !');
            }

            document.getElementById('taskTitle').value = '';
            document.getElementById('taskNotes').value = '';
            saveData();
            render();
        }

        function editTask(id) {
            const task = data.tasks.find(t => t.id === id);
            data.editingId = id;
            data.editingType = 'task';
            
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskType').value = task.type;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskNotes').value = task.notes || '';
            
            document.getElementById('taskFormTitle').textContent = '‚úèÔ∏è Modifier la t√¢che';
            document.getElementById('taskSubmitBtn').textContent = 'üíæ Enregistrer';
            document.getElementById('taskCancelBtn').style.display = 'inline-block';
        }

        function cancelEditTask() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskNotes').value = '';
            document.getElementById('taskFormTitle').textContent = '‚ûï Ajouter une t√¢che';
            document.getElementById('taskSubmitBtn').textContent = 'üìã Ajouter';
            document.getElementById('taskCancelBtn').style.display = 'none';
        }

        // === OBJECTIFS ===
        function addGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            if (!title) return showNotif('‚ö†Ô∏è Entrez un objectif');

            if (data.editingId && data.editingType === 'goal') {
                const goal = data.goals.find(g => g.id === data.editingId);
                goal.title = title;
                goal.category = document.getElementById('goalCategory').value;
                goal.description = document.getElementById('goalDescription').value || '';
                showNotif('‚úèÔ∏è Objectif modifi√© !');
                cancelEditGoal();
            } else {
                data.goals.push({
                    id: Date.now(),
                    title,
                    category: document.getElementById('goalCategory').value,
                    description: document.getElementById('goalDescription').value || '',
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                showNotif('üéØ Objectif ajout√© !');
            }

            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDescription').value = '';
            saveData();
            render();
        }

        function editGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            data.editingId = id;
            data.editingType = 'goal';
            
            document.getElementById('goalTitle').value = goal.title;
            document.getElementById('goalCategory').value = goal.category;
            document.getElementById('goalDescription').value = goal.description || '';
            
            document.getElementById('goalFormTitle').textContent = '‚úèÔ∏è Modifier l\'objectif';
            document.getElementById('goalSubmitBtn').textContent = 'üíæ Enregistrer';
            document.getElementById('goalCancelBtn').style.display = 'inline-block';
        }

        function cancelEditGoal() {
            data.editingId = null;
            data.editingType = null;
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDescription').value = '';
            document.getElementById('goalFormTitle').textContent = 'üéØ Ajouter un objectif';
            document.getElementById('goalSubmitBtn').textContent = 'üéØ Ajouter';
            document.getElementById('goalCancelBtn').style.display = 'none';
        }

        function toggleGoal(id) {
            const goal = data.goals.find(g => g.id === id);
            goal.completed = !goal.completed;
            if (goal.completed) {
                data.points += 100;
                showNotif('üéâ Objectif atteint ! +100 points');
            } else {
                data.points -= 100;
            }
            saveData();
            render();
        }

        function toggleDay(habitId, day) {
            const habit = data.habits.find(h => h.id === habitId);
            if (!habit) {
                console.error('Habitude non trouv√©e:', habitId);
                return;
            }
            
            if (!habit.days) {
                habit.days = [];
            }
            
            const idx = habit.days.indexOf(day);
            
            if (idx > -1) {
                // D√©cocher
                habit.days.splice(idx, 1);
                if (habit.completed > 0) habit.completed--;
                data.points = Math.max(0, data.points - 10);
                console.log('‚úÖ Jour d√©coch√©:', day, 'Points:', data.points);
                showNotif('‚Ü©Ô∏è -10 points');
            } else {
                // Cocher
                habit.days.push(day);
                habit.completed = (habit.completed || 0) + 1;
                data.points += 10;
                console.log('‚úÖ Jour coch√©:', day, 'Points:', data.points);
                showNotif('‚ú® +10 points !');
            }
            
            trackHistory('habit', habitId, idx > -1 ? 'unchecked' : 'checked');
            
            // Sauvegarder PUIS rafra√Æchir
            saveData();
            
            // Rafra√Æchissement IMM√âDIAT sans attendre
            setTimeout(() => {
                render();
                updateCharts();
            }, 10);
        }

        function toggleTask(id) {
            const task = data.tasks.find(t => t.id === id);
            task.completed = !task.completed;
            
            if (task.completed) {
                task.completedAt = new Date().toISOString();
                data.points += 20;
                showNotif('üéâ +20 points !');
            } else {
                task.completedAt = null;
                data.points -= 20;
                showNotif('‚Ü©Ô∏è -20 points');
            }
            
            trackHistory('task', id, task.completed ? 'completed' : 'uncompleted');
            saveData();
            render();
            updateCharts();
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const days = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
            const months = ['janv.', 'f√©vr.', 'mars', 'avr.', 'mai', 'juin', 'juil.', 'ao√ªt', 'sept.', 'oct.', 'nov.', 'd√©c.'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${dayName} ${day} ${month} ${year}, ${hours}:${minutes}`;
        }

        function deleteItem(type, id) {
            if (type === 'habit') {
                data.habits = data.habits.filter(item => item.id !== id);
            } else if (type === 'task') {
                data.tasks = data.tasks.filter(item => item.id !== id);
            } else if (type === 'goal') {
                data.goals = data.goals.filter(item => item.id !== id);
            }
            
            showNotif('üóëÔ∏è Supprim√© !');
            saveData();
            render();
            updateCharts();
        }

        function filterItems(type, filter) {
            data.filter = filter;
            const parent = event.target.parentElement;
            parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }

        function trackHistory(type, id, action) {
            const today = new Date().toISOString().split('T')[0];
            if (!data.history) data.history = [];
            data.history.push({ type, id, action, date: today });
            if (data.history.length > 100) data.history.shift();
        }

        function getWeekDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - d.getDay() + i + 1);
                days.push(d.toISOString().split('T')[0]);
            }
            return days;
        }

        function render() {
            const weekDays = getWeekDays();

            let filteredHabits = data.habits;
            let filteredTasks = data.tasks;
            let filteredGoals = data.goals;

            if (data.filter !== 'all') {
                filteredHabits = data.habits.filter(h => h.type === data.filter);
                filteredTasks = data.tasks.filter(t => t.priority === data.filter || t.type === data.filter);
            }

            // HABITUDES avec vue semaine ou historique
            if (data.habitView === 'week') {
                // Vue semaine actuelle
                const habitsHTML = filteredHabits.length ? filteredHabits.map(h => {
                    const dayBoxes = weekDays.map(day => {
                        const { letter, number } = formatDayBox(day);
                        const isChecked = h.days && h.days.includes(day);
                        const checkedStyle = isChecked ? 
                            'background: linear-gradient(135deg, #74B9FF 0%, #5DADE2 100%); color: white; border-color: #74B9FF; box-shadow: 0 2px 8px rgba(116, 185, 255, 0.4);' : 
                            'background: white; color: #333;';
                        return `
                            <div class="day-box ${isChecked ? 'checked' : ''}" 
                                 style="min-width: 60px; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid ${isChecked ? '#74B9FF' : '#C9A58C'}; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.75em; transition: all 0.2s; padding: 5px; ${checkedStyle}"
                                 onclick="toggleDay(${h.id}, '${day}')">
                                <div class="day-letter" style="font-size: 0.9em; opacity: ${isChecked ? '1' : '0.7'};">${letter}</div>
                                <div class="day-date" style="font-size: 1.1em; margin-top: 2px;">${number}</div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="item-card habit-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1); border-left: 5px solid #74B9FF; margin-bottom: 15px;">
                            <div class="item-header">
                                <div class="item-title">${h.name}</div>
                                <span class="item-badge badge-${h.type}">${
                                    h.type === 'daily' ? 'Quotidienne' :
                                    h.type === 'weekly' ? 'Hebdo' : 'Temporaire'
                                }</span>
                            </div>
                            <div class="item-days" style="display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap;">
                                ${dayBoxes}
                            </div>
                            <p style="color: #666; margin-top: 10px;">‚úÖ ${h.completed || 0} fois compl√©t√©e</p>
                            <div class="item-actions">
                                <button class="btn-small btn-edit" onclick="editHabit(${h.id})">‚úèÔ∏è Modifier</button>
                                <button class="btn-small btn-delete" onclick="deleteItem('habit', ${h.id})">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    `;
                }).join('') : '<div class="empty-state">üì≠ Aucune habitude</div>';
                
                document.getElementById('habitsList').innerHTML = `
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="toggleHabitView('week')">üìÖ Semaine actuelle</button>
                        <button class="view-btn" onclick="toggleHabitView('history')">üìö Historique</button>
                    </div>
                    ${habitsHTML}
                `;
            } else {
                // Vue historique par mois
                const months = getMonthsFromHabits();
                
                const historyHTML = months.length > 0 ? months.map(monthKey => {
                    const monthDays = getDaysInMonth(monthKey);
                    
                    return filteredHabits.map(h => {
                        const daysInThisMonth = h.days ? h.days.filter(d => d.startsWith(monthKey)) : [];
                        
                        if (daysInThisMonth.length === 0) return '';
                        
                        const dayBoxes = monthDays.map(day => {
                            const { letter, number } = formatDayBox(day);
                            const isChecked = h.days && h.days.includes(day);
                            const checkedStyle = isChecked ? 
                                'background: linear-gradient(135deg, #74B9FF 0%, #5DADE2 100%); color: white; border-color: #74B9FF; box-shadow: 0 2px 8px rgba(116, 185, 255, 0.4);' : 
                                'background: white; color: #333;';
                            return `
                                <div class="day-box ${isChecked ? 'checked' : ''}" 
                                     style="min-width: 60px; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid ${isChecked ? '#74B9FF' : '#C9A58C'}; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.75em; transition: all 0.2s; padding: 5px; ${checkedStyle}"
                                     onclick="toggleDay(${h.id}, '${day}')">
                                    <div class="day-letter" style="font-size: 0.9em; opacity: ${isChecked ? '1' : '0.7'};">${letter}</div>
                                    <div class="day-date" style="font-size: 1.1em; margin-top: 2px;">${number}</div>
                                </div>
                            `;
                        }).join('');
                        
                        return `
                            <div class="month-section">
                                <div class="month-header" onclick="toggleMonth(this)">
                                    <div>
                                        <strong>${h.name}</strong> - ${getMonthName(monthKey)}
                                        <span style="margin-left: 15px; color: #81C784; font-size: 0.9em;">
                                            ‚úÖ ${daysInThisMonth.length} jours
                                        </span>
                                    </div>
                                    <span class="month-toggle">‚ñº</span>
                                </div>
                                <div class="month-content">
                                    <div class="item-days" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        ${dayBoxes}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }).join('') : '<div class="empty-state">üì≠ Aucun historique</div>';
                
                document.getElementById('habitsList').innerHTML = `
                    <div class="view-toggle">
                        <button class="view-btn" onclick="toggleHabitView('week')">üìÖ Semaine actuelle</button>
                        <button class="view-btn active" onclick="toggleHabitView('history')">üìö Historique</button>
                    </div>
                    ${historyHTML}
                `;
            }

            // T√ÇCHES
            document.getElementById('tasksList').innerHTML = filteredTasks.length ? filteredTasks.map(t => `
                <div class="item-card task-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(139, 90, 69, 0.1); border-left: 5px solid #81C784; margin-bottom: 15px; ${t.completed ? 'opacity: 0.6;' : ''}">
                    <div class="item-header">
                        <div class="item-title" style="${t.completed ? 'text-decoration: line-through;' : ''}">${t.title}</div>
                        <span class="item-badge badge-${t.priority}">${
                            t.priority === 'urgent' ? 'üî¥ Urgent' :
                            t.priority === 'important' ? 'üü° Important' :
                            t.priority === 'normal' ? 'üü¢ Normal' : 'üîµ Plus tard'
                        }</span>
                    </div>
                    <p style="color: #666; margin: 10px 0;">${t.type === 'work' ? 'üíº Pro' : 'üè† Perso'}</p>
                    ${t.notes ? `<p style="color: #666; font-style: italic; margin-top: 10px;">${t.notes}</p>` : ''}
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #E8D5C4;">
                        <p style="color: #8B5A45; font-size: 0.85em; margin-bottom: 5px;">
                            üìÖ <strong>Cr√©√©e le :</strong> ${formatDate(t.createdAt)}
                        </p>
                        ${t.completed && t.completedAt ? `
                            <p style="color: #81C784; font-size: 0.85em;">
                                ‚úÖ <strong>Accomplie le :</strong> ${formatDate(t.completedAt)}
                            </p>
                        ` : ''}
                    </div>
                    <div class="item-actions">
                        <button class="btn-small btn-done" onclick="toggleTask(${t.id})">
                            ${t.completed ? '‚Ü©Ô∏è R√©activer' : '‚úÖ Terminer'}
                        </button>
                        <button class="btn-small btn-edit" onclick="editTask(${t.id})">‚úèÔ∏è Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('task', ${t.id})">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">üì≠ Aucune t√¢che</div>';

            // OBJECTIFS
            document.getElementById('goalsList').innerHTML = filteredGoals.length ? filteredGoals.map(g => `
                <div class="item-card" style="${g.completed ? 'opacity: 0.6;' : ''}">
                    <div class="item-header">
                        <div class="item-title" style="${g.completed ? 'text-decoration: line-through;' : ''}">${g.title}</div>
                        <span class="item-badge badge-normal">${
                            g.category === 'health' ? 'üèÉ Sant√©' :
                            g.category === 'career' ? 'üíº Carri√®re' :
                            g.category === 'learning' ? 'üìö Apprentissage' :
                            g.category === 'finance' ? 'üí∞ Finance' : 'üåü Personnel'
                        }</span>
                    </div>
                    ${g.description ? `<p style="color: #666; font-style: italic;">${g.description}</p>` : ''}
                    <div class="item-actions">
                        <button class="btn-small btn-done" onclick="toggleGoal(${g.id})">
                            ${g.completed ? '‚Ü©Ô∏è R√©activer' : '‚úÖ Atteint'}
                        </button>
                        <button class="btn-small btn-edit" onclick="editGoal(${g.id})">‚úèÔ∏è Modifier</button>
                        <button class="btn-small btn-delete" onclick="deleteItem('goal', ${g.id})">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">üì≠ Aucun objectif</div>';

            updateStats();
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const completedToday = data.habits.filter(h => h.days.includes(today)).length;
            const completedTasks = data.tasks.filter(t => t.completed).length;

            document.getElementById('totalPoints').textContent = data.points || 0;
            document.getElementById('habitsCompleted').textContent = `${completedToday}/${data.habits.length}`;
            document.getElementById('tasksCompleted').textContent = `${completedTasks}/${data.tasks.length}`;
            document.getElementById('streak').textContent = calculateStreak();
            document.getElementById('rewardsPoints').textContent = (data.points || 0) + ' pts';

            const level = Math.floor((data.points || 0) / 100) + 1;
            const levelNames = ['D√©butant', 'Motiv√©', 'R√©gulier', 'Expert', 'Ma√Ætre', 'L√©gende'];
            document.getElementById('level').textContent = level;
            document.getElementById('levelName').textContent = levelNames[Math.min(level - 1, 5)];
        }

        function calculateStreak() {
            if (!data.history || data.history.length === 0) return 0;
            
            let streak = 0;
            let currentDate = new Date();
            
            for (let i = 0; i < 30; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const hasActivity = data.history.some(h => h.date === dateStr && h.action === 'checked');
                
                if (hasActivity) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function updateCharts() {
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days.push(d.toISOString().split('T')[0]);
            }

            const habitsData = last7Days.map(day => 
                data.habits.filter(h => h.days && h.days.includes(day)).length
            );

            const tasksData = last7Days.map(day => 
                data.tasks.filter(t => t.completed && t.completedAt && t.completedAt.startsWith(day)).length
            );

            if (charts.evolution) charts.evolution.destroy();
            const ctx1 = document.getElementById('evolutionChart').getContext('2d');
            charts.evolution = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => new Date(d).toLocaleDateString('fr', { weekday: 'short' })),
                    datasets: [{
                        label: 'Habitudes',
                        data: habitsData,
                        borderColor: '#74B9FF',
                        backgroundColor: 'rgba(116, 185, 255, 0.2)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#74B9FF',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }, {
                        label: 'T√¢ches',
                        data: tasksData,
                        borderColor: '#81C784',
                        backgroundColor: 'rgba(129, 199, 132, 0.2)',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#81C784',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        } 
                    }
                }
            });

            if (charts.tasks) charts.tasks.destroy();
            const ctx2 = document.getElementById('tasksChart').getContext('2d');
            const urgentTasks = data.tasks.filter(t => t.priority === 'urgent').length;
            const importantTasks = data.tasks.filter(t => t.priority === 'important').length;
            const normalTasks = data.tasks.filter(t => t.priority === 'normal').length;
            const laterTasks = data.tasks.filter(t => t.priority === 'later').length;

            charts.tasks = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Urgentes', 'Importantes', 'Normales', 'Plus tard'],
                    datasets: [{
                        data: [urgentTasks, importantTasks, normalTasks, laterTasks],
                        backgroundColor: ['#FF4D4F', '#FAAD14', '#52C41A', '#1890FF'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function showNotif(msg) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        loadData();
    </script>
</body>
</html>
